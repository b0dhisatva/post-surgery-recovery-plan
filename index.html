<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>David's Recovery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gray-900': '#111827', 'gray-800': '#1F2937', 'gray-700': '#374151',
                        'gray-600': '#4B5563', 'gray-500': '#6B7280', 'gray-400': '#9CA3AF',
                        'gray-300': '#D1D5DB', 'gray-200': '#E5E7EB', 'blue-500': '#3B82F6',
                        'blue-400': '#60A5FA',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #D1D5DB; }
        .main-tab.active, .main-tab:hover { color: #60A5FA; border-bottom-color: #60A5FA; }
        .main-tab { transition: color 0.2s, border-bottom-color 0.2s; border-bottom: 2px solid transparent; }
        .day-card { border-left: 4px solid #3B82F6; } .day-card.phase-2 { border-left-color: #10b981; } .day-card.phase-3 { border-left-color: #8b5cf6; }
        .checkbox-custom { appearance: none; -webkit-appearance: none; height: 1.25rem; width: 1.25rem; border-radius: 0.25rem; border: 2px solid #4B5563; background-color: #374151; cursor: pointer; position: relative; transition: background-color 0.2s, border-color 0.2s; }
        .checkbox-custom:checked { background-color: #3B82F6; border-color: #60A5FA; }
        .checkbox-custom:checked::after { content: '✓'; position: absolute; color: white; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1rem; font-weight: bold; }
        .progress-bar-bg { background-color: #374151; }
        .progress-bar-fg { background-color: #3B82F6; transition: width 0.3s ease-in-out; }
        .phase-tab.active { background-color: #3B82F6; color: white; }
        .modal { transition: opacity 0.25s ease, visibility 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        #app-loader { transition: opacity 0.3s ease-in-out; }
        .rating-emoji { transition: transform 0.2s, filter 0.2s; cursor: pointer; filter: grayscale(80%); transform: scale(1); }
        .rating-emoji.selected, .rating-emoji:hover { filter: grayscale(0%); transform: scale(1.15); }
        .rating-bar { transition: background-color 0.2s; cursor: pointer; }
        .log-entry-form { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
        .log-entry-form.open { max-height: 500px; padding-top: 1rem; padding-bottom: 1rem; }
        .indicator-line { width: 3px; height: 1rem; border-radius: 9999px; display: inline-block; margin-right: 0.375rem; vertical-align: middle; }
        .indicator-injectable { background-color: #60A5FA; }
        .indicator-oral { background-color: #D1D5DB; }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">
    
    <!-- App Loader -->
    <div id="app-loader" class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center">
         <svg class="animate-spin h-8 w-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
         <p id="loader-text" class="mt-4 text-lg text-gray-300">Connecting to Hub...</p>
    </div>

    <!-- Main App Content (hidden by default) -->
    <div id="main-app" class="hidden">
        <header class="bg-gray-800 shadow-lg sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-white mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                        </svg>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-white">David's Recovery Hub</h1>
                            <p class="text-sm text-gray-400">July 12, 2025 - September 30, 2025</p>
                        </div>
                    </div>
                    <nav class="flex items-center space-x-6 mt-4 sm:mt-0">
                        <button data-tab="checklist" class="main-tab font-medium text-gray-300 px-1 py-2 text-base active">Daily Checklist</button>
                        <button data-tab="log" class="main-tab font-medium text-gray-300 px-1 py-2 text-base">Log</button>
                        <button data-tab="protocol" class="main-tab font-medium text-gray-300 px-1 py-2 text-base">Protocol</button>
                    </nav>
                </div>
                 <div class="flex items-center space-x-4 text-xs text-gray-400 pt-2 pb-2">
                    <span>Legend:</span>
                    <div class="flex items-center"><span class="indicator-line indicator-injectable"></span>Injectable</div>
                    <div class="flex items-center"><span class="indicator-line indicator-oral"></span>Oral</div>
                </div>
            </div>
        </header>

        <main class="container mx-auto">
            <div id="checklist-view" class="tab-content">
                <div class="px-4 sm:px-6 lg:px-8 pt-6">
                    <div class="flex items-center space-x-4 text-sm text-gray-400">
                        <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-blue-500 mr-2"></div><span>Phase I</span></div>
                        <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-emerald-500 mr-2"></div><span>Phase II</span></div>
                        <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-violet-500 mr-2"></div><span>Phase III</span></div>
                    </div>
                </div>
                <div id="checklist-container" class="p-4 sm:p-6 lg:p-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="log-view" class="tab-content hidden">
                 <div id="log-container" class="p-4 sm:p-6 lg:p-8 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </div>

            <div id="protocol-view" class="tab-content hidden p-4 sm:p-6 lg:p-8">
                <section id="protocol" class="mb-16 scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Integrated Protocol Timeline</h2>
                    <p class="mb-6 text-gray-400 max-w-3xl">This section presents the core of your recovery plan...</p>
                    <div class="mb-6"><div class="flex flex-wrap border-b border-gray-700">
                            <button data-phase="phase1" class="phase-tab px-4 py-2 font-medium text-gray-300 hover:bg-gray-700 active">Phase I (Wk 1-2)</button>
                            <button data-phase="phase2" class="phase-tab px-4 py-2 font-medium text-gray-300 hover:bg-gray-700">Phase II (Wk 3-6)</button>
                            <button data-phase="phase3" class="phase-tab px-4 py-2 font-medium text-gray-300 hover:bg-gray-700">Phase III (Wk 7-11)</button>
                    </div></div>
                    <div id="protocol-phase1" class="protocol-phase-content"></div>
                    <div id="protocol-phase2" class="protocol-phase-content hidden"></div>
                    <div id="protocol-phase3" class="protocol-phase-content hidden"></div>
                </section>
                <section id="library" class="mb-16 scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Compound Library</h2>
                    <p class="mb-6 text-gray-400 max-w-3xl">Explore the science behind your recovery protocol...</p>
                    <div id="library-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </section>
                <section id="phases" class="mb-16 scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">The Biology of Healing</h2>
                    <p class="mb-8 text-gray-400 max-w-3xl">Your protocol is strategically designed to support the three distinct biological phases of wound repair. Understanding these phases helps clarify the "why" behind each compound's timing.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <!-- Phase 1 Card -->
                        <div class="bg-gray-800 p-6 rounded-lg border-t-4 border-blue-500">
                            <div class="flex justify-center items-center h-16 w-16 rounded-full bg-blue-500/20 mx-auto mb-4">
                                <svg class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10m0-2a7 7 0 11-7 7"/></svg>
                            </div>
                            <h3 class="font-bold text-xl text-white">Phase I: Inflammation</h3>
                            <p class="text-sm font-semibold text-blue-400 mb-2">Day 1 - 7</p>
                            <div class="text-left text-sm text-gray-400 space-y-3">
                                <p><strong class="text-gray-200">What's Happening:</strong> The body's emergency response. Blood vessels constrict to stop bleeding, then dilate to allow immune cells to enter. This creates controlled swelling and redness.</p>
                                <div><strong class="text-gray-200">Key Players:</strong>
                                    <ul class="list-disc list-inside ml-2 mt-1">
                                        <li><strong class="text-gray-300">Platelets:</strong> Form the initial clot.</li>
                                        <li><strong class="text-gray-300">Neutrophils & Macrophages:</strong> Immune cells that clean debris and fight bacteria.</li>
                                    </ul>
                                </div>
                                <p><strong class="text-gray-200">Protocol Goal:</strong> Modulate inflammation with agents like KPV to prevent it from becoming excessive, while providing anti-catabolic support with Anavar to preserve tissue.</p>
                            </div>
                        </div>
                        <!-- Phase 2 Card -->
                        <div class="bg-gray-800 p-6 rounded-lg border-t-4 border-emerald-500">
                             <div class="flex justify-center items-center h-16 w-16 rounded-full bg-emerald-500/20 mx-auto mb-4">
                                <svg class="h-8 w-8 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <h3 class="font-bold text-xl text-white">Phase II: Proliferation</h3>
                            <p class="text-sm font-semibold text-emerald-400 mb-2">Day 4 - Week 6</p>
                             <div class="text-left text-sm text-gray-400 space-y-3">
                                <p><strong class="text-gray-200">What's Happening:</strong> The rebuilding phase. New blood vessels grow into the wound (angiogenesis), and new tissue (granulation tissue) is formed to fill the gap.</p>
                                <div><strong class="text-gray-200">Key Players:</strong>
                                    <ul class="list-disc list-inside ml-2 mt-1">
                                        <li><strong class="text-gray-300">Fibroblasts:</strong> Arrive at the site and produce large amounts of Type III collagen to create a new scaffold.</li>
                                        <li><strong class="text-gray-300">Endothelial Cells:</strong> Form the new blood vessels.</li>
                                    </ul>
                                </div>
                                <p><strong class="text-gray-200">Protocol Goal:</strong> Vigorously support this growth with BPC-157, TB-500, and HGH to accelerate collagen synthesis and angiogenesis, providing the necessary building blocks and energy.</p>
                            </div>
                        </div>
                        <!-- Phase 3 Card -->
                        <div class="bg-gray-800 p-6 rounded-lg border-t-4 border-violet-500">
                            <div class="flex justify-center items-center h-16 w-16 rounded-full bg-violet-500/20 mx-auto mb-4">
                                <svg class="h-8 w-8 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                            </div>
                            <h3 class="font-bold text-xl text-white">Phase III: Remodeling</h3>
                            <p class="text-sm font-semibold text-violet-400 mb-2">Week 4+</p>
                             <div class="text-left text-sm text-gray-400 space-y-3">
                                <p><strong class="text-gray-200">What's Happening:</strong> The maturation phase. The newly formed tissue is reorganized and strengthened. Weaker Type III collagen is replaced by stronger Type I collagen.</p>
                                <div><strong class="text-gray-200">Key Players:</strong>
                                    <ul class="list-disc list-inside ml-2 mt-1">
                                        <li><strong class="text-gray-300">Collagen Type I:</strong> Replaces Type III for greater tensile strength.</li>
                                        <li><strong class="text-gray-300">MMPs (Enzymes):</strong> Help break down the old matrix so it can be rebuilt in a more organized way.</li>
                                    </ul>
                                </div>
                                <p><strong class="text-gray-200">Protocol Goal:</strong> Guide the scar's final appearance with GHK-Cu to ensure collagen is aligned properly, and use Red Light Therapy to maintain cellular energy for this long-term process.</p>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="risks" class="scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Risk & Safety Center</h2>
                     <p class="mb-6 text-gray-400 max-w-3xl">This section consolidates the critical risk information...</p>
                    <div class="bg-rose-900/50 border border-rose-500/30 text-rose-300 p-4 rounded-lg mb-6"><h3 class="font-bold text-rose-200">⚠️ Critical Disclaimer</h3><p class="text-sm">This protocol is for informational purposes ONLY...</p></div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg"><div class="overflow-x-auto">
                        <table class="w-full table-auto text-left text-sm"><thead class="bg-gray-700/50 text-gray-300"><tr>
                            <th class="p-3 font-semibold">Compound</th><th class="p-3 font-semibold">FDA Status</th><th class="p-3 font-semibold">Primary Risks</th><th class="p-3 font-semibold">Monitoring / Contraindications</th>
                        </tr></thead><tbody id="risk-table" class="divide-y divide-gray-700"></tbody></table>
                    </div></div>
                </section>
            </div>
        </main>
        <div id="compound-modal" class="modal invisible opacity-0 fixed inset-0 w-full h-full bg-black/80 flex items-center justify-center p-4 z-40">
            <div class="modal-content bg-gray-800 w-full max-w-2xl max-h-[90vh] rounded-lg shadow-xl border border-gray-700 transform scale-95 overflow-y-auto">
                <div class="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 id="modal-title" class="text-2xl font-bold text-white"></h3>
                    <button id="modal-close" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                </div><div id="modal-body" class="p-6"></div>
            </div>
        </div>
        <div id="uncheck-confirm-modal" class="modal invisible opacity-0 fixed inset-0 w-full h-full bg-black/80 flex items-center justify-center p-4 z-50">
             <div class="modal-content bg-gray-800 w-full max-w-md rounded-lg shadow-xl border border-gray-700 transform scale-95 p-6 text-center">
                <h3 class="text-xl font-bold text-white mb-4">Confirm Action</h3>
                <p class="text-gray-300 mb-6">Are you sure you want to mark this item as incomplete? This action will be synced for all users.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-uncheck" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancel</button>
                    <button id="confirm-uncheck" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyBvOuLfBr1-faAK7RC5QkgD6hxhD9oWaP0",
                authDomain: "post-surgery-recovery-plan.firebaseapp.com",
                projectId: "post-surgery-recovery-plan",
                storageBucket: "post-surgery-recovery-plan.appspot.com",
                messagingSenderId: "640490803020",
                appId: "1:640490803020:web:07a9a0322792daff0d89e9",
                measurementId: "G-R4BG49JC7N"
            };

            const appData = {
                checklist: { startDate: '2025-07-12', endDate: '2025-09-30', phases: [{ name: "Phase I", start: 0, end: 13, class: 'day-card' },{ name: "Phase II", start: 14, end: 41, class: 'phase-2' },{ name: "Phase III", start: 42, end: 80, class: 'phase-3' }], items: { "bpc-157": { key: "bpc-157", name: "BPC-157", type: 'injectable', dose: "400mcg", inj: "12 IU", time: "AM", freq: "daily", phases: [1, 2, 3] }, "bpc-157-pm": { key: "bpc-157", name: "BPC-157", type: 'injectable', dose: "400mcg", inj: "12 IU", time: "PM", freq: "daily", phases: [1, 2, 3] }, "tb-500": { key: "tb-500", name: "TB-500", type: 'injectable', dose: "1mg", inj: "60 IU", time: "Any", freq: "daily", phases: [1, 2, 3] }, "kpv": { key: "kpv", name: "KPV", type: 'injectable', dose: "400mcg", inj: "12 IU", time: "AM", freq: "daily", phases: [1] }, "kpv-pm": { key: "kpv", name: "KPV", type: 'injectable', dose: "400mcg", inj: "12 IU", time: "PM", freq: "daily", phases: [1] }, "oxandrolone": { key: "oxandrolone", name: "Anavar", type: 'oral', dose: "6.25mg", time: "AM", freq: "daily", phases: [1, 2, 3] }, "oxandrolone-pm": { key: "oxandrolone", name: "Anavar", type: 'oral', dose: "6.25mg", time: "PM", freq: "daily", phases: [1, 2, 3] }, "collagen": { key: "collagen", name: "Collagen", type: 'oral', dose: "15g", time: "AM", freq: "daily", phases: [1, 2, 3] }, "collagen-pm": { key: "collagen", name: "Collagen", type: 'oral', dose: "15g", time: "PM", freq: "daily", phases: [1, 2, 3] }, "vit-c": { key: "vit-c", name: "Vit C", type: 'oral', dose: "1g", time: "AM Meal", freq: "daily", phases: [1, 2, 3] }, "vit-c-pm": { key: "vit-c", name: "Vit C", type: 'oral', dose: "1g", time: "PM Meal", freq: "daily", phases: [1, 2, 3] }, "vit-d": { key: "vit-d", name: "Vit D3", type: 'oral', dose: "5,000 IU", time: "With Meal", freq: "daily", phases: [1, 2, 3] }, "ha-oral": { key: "ha", name: "Hyaluronic Acid", type: 'oral', dose: "200mg", time: "Any", freq: "daily", phases: [1, 2, 3] }, "ghk-cu": { key: "ghk-cu", name: "GHK-Cu", type: 'injectable', dose: "1mg", inj: "4 IU", time: "PM", freq: "daily", phases: [2, 3] }, "hgh": { key: "hgh", name: "HGH", type: 'injectable', dose: "1.5 IU", inj: "11 IU", time: "AM", freq: "daily", phases: [2, 3] }, "hgh-pm": { key: "hgh", name: "HGH", type: 'injectable', dose: "1.5 IU", inj: "11 IU", time: "PM", freq: "daily", phases: [2, 3] }, "rlt": { key: "rlt", name: "Red Light Therapy", type: 'therapy', dose: "10-15 min", time: "Any", freq: "eod", phases: [2, 3] }, "retatrutide-p2": { key: "retatrutide", name: "Retatrutide", type: 'injectable', dose: "2mg", inj: "60 IU", time: "Any", freq: "weekly", phases: [2], startWeek: 3 }, "retatrutide-p3": { key: "retatrutide", name: "Retatrutide", type: 'injectable', dose: "4mg", inj: "120 IU (split)", time: "Any", freq: "weekly", phases: [3] } } },
                protocol: { "bpc-157": { name: "BPC-157", type: 'injectable', category: "Peptide", status: "research", info: { Background: "Body Protection Compound-157 (BPC-157) is a synthetic peptide composed of 15 amino acids, corresponding to a partial sequence of a protein found in human gastric juice. It was originally isolated for its cytoprotective and organ-protective effects within the gastrointestinal tract. However, extensive preclinical research has revealed its potent systemic and localized regenerative capabilities, making it a subject of intense interest in sports medicine and regenerative protocols.", Mechanism: "BPC-157's primary healing mechanism is its powerful pro-angiogenic effect. It significantly stimulates the expression of Vascular Endothelial Growth Factor (VEGF), a key signaling protein that promotes the formation of new blood vessels (angiogenesis). This enhanced vascularity increases the delivery of oxygen, nutrients, and reparative cells to injured tissue. Additionally, BPC-157 promotes the migration and proliferation of fibroblasts, the cells responsible for synthesizing collagen, and upregulates the expression of Growth Hormone Receptors on these cells, potentially sensitizing the tissue to the anabolic effects of HGH.", Research: "In numerous animal models, BPC-157 has demonstrated accelerated healing of a wide array of tissues, including skin incisions, muscle tears, tendon-to-bone injuries, and even nerve damage. It has also shown efficacy in counteracting the damaging effects of NSAIDs on the gut lining. While large-scale human trials are lacking, its strong safety profile in animal studies and extensive anecdotal evidence have led to its widespread use in off-label regenerative contexts.", Administration: "For localized tissue repair such as post-surgical incisions, subcutaneous injection near the site of injury is considered the most effective route. This allows for high local concentrations of the peptide to act directly on the healing tissue. A dosage of 400mcg twice daily provides a robust signal for repair during the critical healing phases.", Safety: "BPC-157 is not approved by the FDA for human use. The primary risk is associated with sourcing from unregulated markets, which can lead to issues of purity, contamination, or incorrect dosage. In research settings, it has exhibited a very high safety profile with no significant adverse effects reported. Human anecdotal reports are generally limited to mild, transient effects like nausea or fatigue at higher doses." } },
                "tb-500": { name: "TB-500", type: 'injectable', category: "Peptide", status: "research", info: { Background: "TB-500 is the synthetic version of Thymosin Beta-4 (Tβ4), a naturally occurring 43-amino-acid peptide. Tβ4 is found in virtually all human and animal cells but is found in particularly high concentrations in wound fluid and platelets, highlighting its central role in the body's natural repair processes.", Mechanism: "The principal mechanism of Tβ4 is its interaction with actin, a critical protein for cell structure and motility. By binding to actin, Tβ4 promotes the migration of cells—including stem/progenitor cells, endothelial cells, and fibroblasts—to the site of injury. It also has potent anti-inflammatory effects, downregulating inflammatory cytokines like TNF-α and IL-6. This creates a more favorable environment for tissue regeneration. Furthermore, it promotes angiogenesis and has been shown to reduce the formation of fibrotic scar tissue.", Research: "Preclinical studies have shown that Tβ4 significantly accelerates dermal wound healing, improves collagen deposition, and reduces scarring. It has also demonstrated protective and regenerative effects in models of cardiac injury, spinal cord injury, and other tissue damage. Its systemic nature makes it a powerful agent for addressing the widespread micro-trauma associated with major surgery.", Administration: "TB-500 is administered systemically via subcutaneous injection. A daily dose of 1mg is used in this protocol to maintain consistently elevated systemic levels, providing a continuous signal for repair throughout the body.", Safety: "Like BPC-157, TB-500 is not FDA-approved for human use and is on the WADA prohibited list. The main theoretical risk stems from its potent pro-angiogenic properties, which could potentially accelerate the growth of undiagnosed tumors. Therefore, it is strongly contraindicated in individuals with a history of or active cancer. Otherwise, it has shown a high safety profile in research." } },
                "ghk-cu": { name: "GHK-Cu (Injectable)", type: 'injectable', category: "Peptide", status: "research", info: { Background: "GHK-Cu is a naturally occurring copper peptide complex (glycyl-L-histidyl-L-lysine bound to a copper ion) that was first isolated from human plasma. Its concentration in the body declines sharply with age, which is believed to be a key factor in the diminished regenerative capacity of older tissue. It is widely used in high-end cosmetic products for its skin remodeling effects.", Mechanism: "GHK-Cu's primary function is to regulate the complex process of extracellular matrix (ECM) remodeling. It has the unique ability to stimulate the synthesis of new, healthy collagen and elastin while also stimulating the enzymatic breakdown and removal of old, damaged, and disorganized proteins found in scar tissue. Its most profound effect may be its ability to modulate the expression of thousands of human genes, essentially resetting them towards a more youthful and regenerative state. It upregulates genes involved in antioxidant defense and tissue repair while downregulating those associated with inflammation and tissue destruction.", Research: "Decades of research have demonstrated GHK-Cu's ability to tighten loose skin, improve elasticity, increase skin density and firmness, reduce fine lines and wrinkles, and improve photodamage. Its application in scar treatment is based on its ability to replace disorganized scar collagen with healthy, properly aligned collagen.", Administration: "While topical application is most common, systemic subcutaneous injection is used in this protocol to support widespread dermal health and remodeling, which is particularly relevant after a procedure like a fleur-de-lis abdominoplasty that involves extensive skin manipulation. It is introduced in Phase II to guide the remodeling process after the initial inflammatory phase has resolved.", Safety: "Injectable GHK-Cu is not FDA-approved and is sourced from compounding pharmacies. The primary risk is associated with systemic copper administration, making it contraindicated for individuals with copper metabolism disorders like Wilson's disease. Potential side effects can include flushing, nausea, or injection site reactions." } },
                "kpv": { name: "KPV", type: 'injectable', category: "Peptide", status: "research", info: { Background: "KPV (Lys-Pro-Val) is a tripeptide fragment representing the C-terminal end of alpha-melanocyte-stimulating hormone (α-MSH). This fragment was isolated because it retains the potent anti-inflammatory properties of α-MSH without any of its pigmentary (tanning) effects.", Mechanism: "Unlike many anti-inflammatory agents that work outside the cell, KPV acts intracellularly. It is transported into the cell nucleus where it inhibits key inflammatory signaling pathways, most notably NF-κB. This prevents the transcription and production of a wide range of pro-inflammatory cytokines (e.g., TNF-α, IL-1β, IL-6). This action effectively 'cools down' an excessive inflammatory response without completely shutting it off, allowing the necessary healing processes to proceed in a more controlled and less damaging manner. It also possesses antimicrobial properties.", Research: "Research has shown KPV to be effective in reducing inflammation in models of inflammatory bowel disease, contact dermatitis, and other inflammatory conditions. Its use in a post-surgical context is to manage the acute inflammatory cascade, thereby reducing pain, swelling, and the potential for excessive scar formation that can result from prolonged inflammation.", Administration: "Subcutaneous injection provides systemic anti-inflammatory benefits, which is ideal for managing the body-wide stress response from major surgery. The dose is split into AM and PM administrations to maintain stable levels during the acute Phase I healing period.", Safety: "KPV is an unapproved research peptide. Human data is scarce, but reported side effects are typically very mild. As with all such peptides, the primary risk lies in the purity and sterility of the product sourced from unregulated markets." } },
                "hgh": { name: "HGH", type: 'injectable', category: "Hormone", status: "prescription", info: { Background: "Human Growth Hormone (HGH, or Somatropin) is a 191-amino acid peptide hormone secreted by the pituitary gland. It is a master regulatory hormone that governs growth, metabolism, and tissue repair throughout life. Its production naturally declines with age, a process known as somatopause.", Mechanism: "HGH exerts its effects both directly and indirectly. Its primary indirect mechanism is stimulating the liver to produce Insulin-like Growth Factor 1 (IGF-1), which is a powerful driver of cellular growth and proliferation. Directly, HGH is a potent stimulator of collagen synthesis, providing the raw material for new skin, tendons, and ligaments. It also promotes the proliferation of fibroblasts, the cells that create collagen. This makes it a cornerstone of post-surgical healing protocols.", Research: "The use of HGH to improve healing is well-documented. Studies in burn patients and those with large wounds have shown that HGH administration can significantly accelerate wound closure and improve protein synthesis. Its ability to increase collagen deposition is critical for enhancing the tensile strength of healing incisions.", Administration: "HGH is administered via subcutaneous injection. Splitting the daily dose of 3 IU into a 1.5 IU morning injection and a 1.5 IU evening injection helps to mimic a more natural secretion pattern and can reduce the risk of side effects like water retention. It is introduced in Phase II, after the most acute phase of post-surgical stress has passed.", Safety: "HGH is a prescription drug and a controlled substance. Its use requires medical supervision. Common side effects are dose-dependent and can include edema (water retention), arthralgia (joint pain), and carpal tunnel syndrome. It is contraindicated in patients with active cancer or acute critical illness following surgery." } },
                "retatrutide": { name: "Retatrutide", type: 'injectable', category: "Peptide", status: "experimental", info: { Background: "Retatrutide is a cutting-edge, investigational peptide currently in late-stage clinical trials. It is a novel triple-receptor agonist, meaning it simultaneously activates three different hormone receptors: GLP-1, GIP, and Glucagon. This multi-pronged action makes it one of the most powerful metabolic agents ever studied.", Mechanism: "While its primary indication is for weight loss and diabetes, its mechanism is highly beneficial for a recovery state. By optimizing insulin sensitivity and glucose disposal, it ensures that the body's energy is efficiently partitioned towards tissue repair rather than fat storage. It also significantly improves lipid profiles and has been shown to reduce systemic inflammation and markers of liver fibrosis. This creates an ideal, low-inflammation, metabolically efficient internal environment for healing.", Research: "Phase II and III clinical trials have demonstrated unprecedented levels of weight loss and improvements in a wide array of cardiometabolic health markers. Its anti-inflammatory and metabolic-optimizing effects are the rationale for its inclusion in an advanced recovery protocol.", Administration: "The protocol introduces it at a starting dose of 2mg weekly in late Phase II, titrating up to 4mg weekly in Phase III. The 4mg dose would need to be split into two separate 2mg injections due to volume.", Safety: "Retatrutide is an investigational new drug and is not legally available outside of sanctioned clinical trials. Its inclusion in this protocol is purely speculative. Common side effects reported in trials are primarily gastrointestinal in nature, such as nausea and vomiting, especially during dose escalation." } },
                "oxandrolone": { name: "Oxandrolone", type: 'oral', category: "Anabolic Agent", status: "prescription-c", info: { Background: "Oxandrolone (brand name Anavar) is a synthetic derivative of dihydrotestosterone (DHT), first synthesized in the 1960s. It is an oral anabolic-androgenic steroid (AAS) prized in medical settings for its high anabolic activity coupled with low androgenic side effects, making it suitable for therapeutic use in both men and women.", Mechanism: "Major surgery induces a profound catabolic state, where the body breaks down its own muscle tissue to supply amino acids for the stress response. Oxandrolone powerfully counteracts this by binding to androgen receptors in muscle cells, which directly stimulates protein synthesis and inhibits protein breakdown (anti-catabolism). This shifts the body's nitrogen balance from negative to positive, preserving lean body mass and providing a surplus of amino acids that can be used for wound healing.", Research: "The efficacy of Oxandrolone in accelerating recovery is well-established, particularly in studies of patients with severe burns, which represent an extreme model of surgical trauma. Clinical trials have consistently shown that it significantly accelerates wound healing, reduces the loss of lean body mass, and improves net protein balance.", Administration: "The daily dose of 12.5mg is split into two 6.25mg doses (AM and PM) to maintain stable blood levels and minimize potential side effects. It is used throughout all phases to provide continuous anti-catabolic support.", Safety: "Oxandrolone is a Schedule III controlled substance and requires a prescription. As a 17-alpha-alkylated steroid, it is processed by the liver and carries a risk of hepatotoxicity. It also has a significant negative impact on cholesterol levels, suppressing HDL ('good' cholesterol) and raising LDL ('bad' cholesterol). For these reasons, **mandatory bloodwork to monitor liver enzymes (AST/ALT) and a full lipid panel is absolutely required** before, during, and after the cycle." } },
                "collagen": { name: "Multi-Collagen Powder", type: 'oral', category: "Supplement", status: "supplement", info: { Background: "Collagen is the most abundant protein in the human body, serving as the primary structural component of skin, bones, tendons, and other connective tissues. Oral collagen supplements are typically derived from bovine, marine, or chicken sources and are hydrolyzed into smaller peptides for enhanced absorption.", Mechanism: "When ingested, hydrolyzed collagen peptides are absorbed into the bloodstream and travel throughout the body. They provide the specific amino acids—primarily glycine, proline, and hydroxyproline—that are the essential raw materials for the body's own collagen production. Furthermore, these peptides can act as signaling molecules, stimulating fibroblasts to increase their synthesis of new collagen, elastin, and hyaluronic acid.", Research: "Numerous clinical studies have demonstrated that regular supplementation with 10-20 grams of hydrolyzed collagen peptides can improve skin hydration, elasticity, and density. For wound healing, providing an abundant supply of these key amino acids is critical to support the high demand for new tissue construction.", Administration: "A daily dose of 30g, split into two 15g servings, ensures a continuous and ample supply of these crucial building blocks for the duration of the recovery period.", Safety: "Collagen supplements are designated as Generally Recognized as Safe (GRAS) by the FDA. They are very well-tolerated with an extremely low risk of side effects." } },
                "vit-c": { name: "Vitamin C", type: 'oral', category: "Supplement", status: "supplement", info: { Background: "Vitamin C (ascorbic acid) is a water-soluble vitamin that is essential for human health. Unlike most mammals, humans cannot synthesize their own Vitamin C and must obtain it from their diet. It is a powerful antioxidant and a critical cofactor in numerous enzymatic reactions.", Mechanism: "Its most critical role in wound healing is as an essential cofactor for the enzymes prolyl hydroxylase and lysyl hydroxylase. These enzymes are responsible for the formation of stable, strong collagen triple-helices. Without adequate Vitamin C, the body can produce collagen, but it will be weak and unstable, leading to impaired healing. The physiological stress of surgery dramatically increases the body's demand for Vitamin C.", Research: "A large body of evidence supports the use of high-dose Vitamin C to promote wound healing. Studies show that supplementation can enhance collagen synthesis and accelerate the rate of functional recovery. Doses of 1-2 grams per day are often recommended in clinical settings for post-operative patients.", Administration: "A therapeutic dose of 2 grams per day, split into two 1-gram doses with meals, is used to support the high demand for collagen synthesis and mitigate oxidative stress.", Safety: "Vitamin C is extremely safe. As a water-soluble vitamin, any excess is excreted in the urine. The primary side effect of very high doses can be mild gastrointestinal upset, which is mitigated by splitting the dose." } },
                "vit-d": { name: "Vitamin D3", type: 'oral', category: "Supplement", status: "supplement", info: { Background: "Vitamin D is a fat-soluble vitamin that functions as a steroid hormone. It is synthesized in the skin upon exposure to sunlight and can also be obtained from food and supplements. It plays a crucial role in calcium homeostasis, immune function, and cell regulation.", Mechanism: "In the context of wound healing, Vitamin D is a critical modulator of the immune system, helping to regulate the inflammatory response. It also plays a direct role in the proliferation and differentiation of keratinocytes, the primary cells that make up the epidermis, which is essential for wound closure. Furthermore, it influences the production of various growth factors involved in tissue repair.", Research: "Vitamin D deficiency is common and has been clearly linked to an increased risk of surgical site infections and impaired healing outcomes. Ensuring adequate Vitamin D levels is considered a fundamental component of preparing for and recovering from surgery.", Administration: "A daily dose of 5,000 IU is a standard and effective dose for maintaining optimal blood levels. However, the ideal approach is to test pre-operative Vitamin D levels (25-hydroxyvitamin D) and dose accordingly to correct any deficiency.", Safety: "Vitamin D is very safe at the recommended dosage. Toxicity is rare and typically only occurs with extremely high, prolonged doses." } },
                "ha": { name: "Hyaluronic Acid", type: 'oral', category: "Supplement", status: "supplement", info: { Background: "Hyaluronic Acid (HA) is a large glycosaminoglycan, a type of polysaccharide, that is a major component of the skin's extracellular matrix (ECM). It is renowned for its ability to bind and retain water molecules, making it a key molecule for tissue hydration and lubrication.", Mechanism: "HA plays an active role in all phases of wound healing. In the initial phase, it helps form the provisional matrix for cell migration. During the proliferative phase, it creates a hydrated and viscous environment that facilitates the movement of fibroblasts and other reparative cells. It also has signaling functions, interacting with cell surface receptors to promote cell proliferation and modulate the inflammatory response.", Research: "Clinical studies on oral HA supplementation have shown improvements in skin hydration, elasticity, and wrinkle reduction. In the context of healing, providing systemic HA supports the overall health and plasticity of the dermal matrix from the inside out.", Administration: "A daily oral dose of 200mg is used to support systemic hydration and provide a key building block for the ECM.", Safety: "Oral Hyaluronic Acid is designated as Generally Recognized as Safe (GRAS) and has an excellent safety profile with no significant side effects." } },
                "rlt": { name: "Red Light Therapy", type: 'therapy', category: "Therapy", status: "device", info: { Background: "Red Light Therapy (RLT), also known as Photobiomodulation (PBM), is a therapeutic modality that uses specific wavelengths of red and near-infrared (NIR) light to stimulate cellular processes. It is a non-invasive therapy that works by delivering light energy directly to the cells.", Mechanism: "The primary mechanism of RLT is the absorption of photons by a specific enzyme in the mitochondria called cytochrome c oxidase. This absorption enhances the activity of the mitochondrial respiratory chain, leading to a significant increase in the production of ATP (cellular energy). This boost in cellular energy powers all aspects of healing, including fibroblast proliferation, collagen synthesis, and cell migration. RLT also helps to reduce inflammation and oxidative stress in the treated tissue.", Research: "A vast body of research supports the use of PBM for accelerating wound healing, reducing pain, and improving scar appearance. Specific wavelengths in the red (630-660nm) and NIR (810-850nm) ranges have been identified as most effective. The key is delivering the correct dose of energy (fluence, measured in J/cm²).", Administration: "The protocol calls for daily or every-other-day sessions of 10-15 minutes, targeting the surgical sites. This provides a consistent energetic boost to the healing tissues throughout the critical proliferative and remodeling phases.", Safety: "RLT is considered very safe. The primary risk is potential eye damage if appropriate protective eyewear is not used when operating high-output devices. Skin irritation is rare but possible." } }
            };

            let db;
            let checklistDocRef;
            let logsDocRef;
            let unsubscribeChecklist;
            let unsubscribeLogs;
            let checkboxToUncheck = null;
            
            const mainApp = document.getElementById('main-app');
            const appLoader = document.getElementById('app-loader');
            const loaderText = document.getElementById('loader-text');
            const modal = document.getElementById('compound-modal');
            const uncheckModal = document.getElementById('uncheck-confirm-modal');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalClose = document.getElementById('modal-close');
            const confirmUncheckBtn = document.getElementById('confirm-uncheck');
            const cancelUncheckBtn = document.getElementById('cancel-uncheck');

            function runApp() {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    appLoader.classList.remove('hidden');
                    loaderText.textContent = "Firebase config missing in HTML file.";
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                checklistDocRef = doc(db, "recoveryState", "checklist");
                logsDocRef = doc(db, "recoveryState", "logs");

                startApp();
            }

            async function startApp() {
                appLoader.classList.remove('hidden');
                initializeProtocolView();
                initializeChecklist();
                initializeLogView();
                handleTabSwitching();
                setupUncheckModalListeners();
                
                unsubscribeChecklist = onSnapshot(checklistDocRef, (docSnap) => {
                    const remoteData = docSnap.exists() ? docSnap.data() : {};
                    updateCheckboxesFromRemote(remoteData);
                }, (error) => {
                    console.error("Firebase connection error:", error);
                    let userMessage = "Connection Error. Please check the browser console for details.";
                    if (error.code === 'permission-denied') {
                        userMessage = "Connection Failed: Permission Denied. Please check your Firebase Security Rules and ensure they are set to 'allow read, write: if true;'.";
                    }
                    loaderText.innerHTML = `<span class="text-red-400">${userMessage}</span>`;
                });
                
                unsubscribeLogs = onSnapshot(logsDocRef, (docSnap) => {
                    const remoteData = docSnap.exists() ? docSnap.data() : {};
                    updateLogsFromRemote(remoteData);
                });

                appLoader.classList.add('opacity-0', 'pointer-events-none');
                mainApp.classList.remove('hidden');
            }
            
            function updateCheckboxStateInFirestore(id, data) {
                 const updateData = { [id]: data };
                 setDoc(checklistDocRef, updateData, { merge: true });
            }
            
            function updateCheckboxesFromRemote(remoteData) {
                document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(checkbox => {
                    const checkboxData = remoteData[checkbox.id];
                    const shouldBeChecked = checkboxData && checkboxData.checked === true;
                    
                    if (checkbox.checked !== shouldBeChecked) {
                        checkbox.checked = shouldBeChecked;
                    }

                    const timestampEl = document.getElementById(`ts-${checkbox.id}`);
                    if (shouldBeChecked && checkboxData.ts) {
                        timestampEl.textContent = `Completed: ${checkboxData.ts}`;
                        timestampEl.classList.remove('hidden');
                    } else {
                        timestampEl.textContent = '';
                        timestampEl.classList.add('hidden');
                    }

                    const dayCard = checkbox.closest('.day-card');
                    if(dayCard) updateDayProgress(dayCard);
                });
            }

            function updateDayProgress(dayCard) {
                const checkboxes = dayCard.querySelectorAll('input[type="checkbox"]');
                const progressBar = dayCard.querySelector('.progress-bar-fg');
                if (!progressBar) return;
                const totalCheckboxes = checkboxes.length;
                const checkedCount = dayCard.querySelectorAll('input[type="checkbox"]:checked').length;
                const progressPercentage = totalCheckboxes > 0 ? (checkedCount / totalCheckboxes) * 100 : 0;
                progressBar.style.width = `${progressPercentage}%`;
            }

            function handleCheckboxClick(e) {
                e.preventDefault();
                const checkbox = e.target;
                if (checkbox.checked) {
                    checkboxToUncheck = checkbox;
                    uncheckModal.classList.remove('invisible', 'opacity-0');
                } else {
                    const timestamp = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    updateCheckboxStateInFirestore(checkbox.id, { checked: true, ts: timestamp });
                }
            }
            
            function setupUncheckModalListeners() {
                function closeUncheckModal() {
                    uncheckModal.classList.add('invisible', 'opacity-0');
                    checkboxToUncheck = null;
                }
                
                cancelUncheckBtn.addEventListener('click', closeUncheckModal);
                uncheckModal.addEventListener('click', (e) => {
                    if (e.target === uncheckModal) closeUncheckModal();
                });

                confirmUncheckBtn.addEventListener('click', () => {
                    if (checkboxToUncheck) {
                        updateCheckboxStateInFirestore(checkboxToUncheck.id, { checked: false, ts: null });
                    }
                    closeUncheckModal();
                });
            }

            function initializeChecklist() {
                const checklistContainer = document.getElementById('checklist-container');
                checklistContainer.innerHTML = '';
                const { startDate: start, endDate: end, phases, items } = appData.checklist;
                const startDate = new Date(start + 'T00:00:00');
                const endDate = new Date(end + 'T00:00:00');
                let currentDate = new Date(startDate);
                let dayCounter = 0;
                let dayOfWeekCounter = currentDate.getDay();

                const timeSortOrder = { 'AM': 1, 'AM Meal': 1, 'Any': 2, 'With Meal': 2, 'Evening': 3, 'PM': 3, 'PM Meal': 3 };

                while (currentDate <= endDate) {
                    const dayIndex = dayCounter;
                    const currentPhaseInfo = phases.find(p => dayIndex >= p.start && dayIndex <= p.end);
                    const currentPhaseNumber = phases.indexOf(currentPhaseInfo) + 1;
                    const dayCard = document.createElement('div');
                    dayCard.className = `day-card ${currentPhaseInfo.class} bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col`;
                    dayCard.id = `day-${dayIndex}`;
                    const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    
                    let itemsForDay = [];
                    for (const key in items) {
                        const item = items[key];
                        if (item.phases.includes(currentPhaseNumber)) {
                            let shouldAdd = false;
                            if(item.freq === 'daily' || (item.freq === 'eod' && dayIndex % 2 === 0) ) {
                               shouldAdd = true;
                            } else if (item.freq === 'weekly' && dayOfWeekCounter % 7 === 0) {
                                 shouldAdd = true;
                                 if(item.startWeek) {
                                    const phaseStartDate = new Date(start);
                                    phaseStartDate.setDate(phaseStartDate.getDate() + currentPhaseInfo.start);
                                    const itemStartDate = new Date(phaseStartDate);
                                    itemStartDate.setDate(itemStartDate.getDate() + (item.startWeek - 1) * 7);
                                    if(currentDate < itemStartDate) shouldAdd = false;
                               }
                            }
                            if(shouldAdd) itemsForDay.push({ ...item, checklistKey: key });
                        }
                    }

                    itemsForDay.sort((a, b) => (timeSortOrder[a.time] || 99) - (timeSortOrder[b.time] || 99));

                    let checklistHTML = itemsForDay.map(item => {
                        const id = `check-${dayIndex}-${item.checklistKey}`;
                        const injText = item.inj ? `<span class="font-mono text-xs text-blue-400">${item.inj}</span>` : '';
                        const indicatorLine = item.type === 'therapy' ? '' : `<span class="indicator-line ${item.type === 'injectable' ? 'indicator-injectable' : 'indicator-oral'}"></span>`;
                        return `<div class="flex items-center justify-between py-2 border-b border-gray-700 last:border-b-0">
                                <label class="flex items-start cursor-pointer flex-grow mr-2">
                                    <input type="checkbox" id="${id}" class="checkbox-custom mr-3 flex-shrink-0 mt-1">
                                    <div class="min-w-0">
                                        <div>
                                            ${indicatorLine}
                                            <span class="font-medium text-gray-200">${item.name}</span>
                                            <span class="text-sm text-gray-400 ml-2">${item.dose}</span>
                                        </div>
                                        <div id="ts-${id}" class="text-xs text-blue-400 mt-1 hidden ml-7"></div>
                                    </div>
                                </label>
                                ${injText}<span class="text-sm text-gray-500 ml-auto pl-2 text-right self-start mt-1">${item.time}</span></div>`;
                    }).join('');

                    dayCard.innerHTML = `<div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-white">${dateString}</h3>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${currentPhaseInfo.class === 'day-card' ? 'bg-blue-500/20 text-blue-300' : currentPhaseInfo.class === 'phase-2' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-violet-500/20 text-violet-300'}">${currentPhaseInfo.name}</span>
                        </div><div class="flex-grow">${checklistHTML || '<p class="text-gray-500 text-sm py-2">Rest day from scheduled therapies.</p>'}</div>
                        <div class="mt-4"><div class="progress-bar-bg w-full h-2 rounded-full overflow-hidden"><div class="progress-bar-fg h-full" style="width: 0%;"></div></div></div>`;
                    checklistContainer.appendChild(dayCard);
                    
                    dayCard.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('click', handleCheckboxClick);
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                    dayCounter++;
                    dayOfWeekCounter++;
                }
            }
            
            function initializeProtocolView() {
                 populateProtocolTables(); populateLibrary(); populateRiskTable(); setupProtocolEventListeners();
            }
            function populateProtocolTables() {
                const { protocol } = appData; const phaseContainers = { phase1: document.getElementById('protocol-phase1'), phase2: document.getElementById('protocol-phase2'), phase3: document.getElementById('protocol-phase3'), };
                for (const phase in phaseContainers) { let tableRowsHTML = ''; for (const key in protocol) { const compound = protocol[key]; if (compound.phases[phase]) { const pData = compound.phases[phase];
                const indicatorLine = compound.type === 'therapy' ? '' : `<span class="indicator-line ${compound.type === 'injectable' ? 'indicator-injectable' : 'indicator-oral'}"></span>`;
                tableRowsHTML += `<tr class="hover:bg-gray-700/50"><td class="p-3 font-medium"><button data-key="${key}" class="compound-link text-blue-400 hover:text-blue-300 hover:underline">${indicatorLine}${compound.name}</button></td><td class="p-3 text-gray-300">${pData.dosage}</td><td class="p-3 text-gray-300">${pData.freq}</td><td class="p-3 text-gray-300">${pData.time}</td><td class="p-3 text-gray-300 font-mono">${pData.injectionAmount || '—'}</td></tr>`; } }
                phaseContainers[phase].innerHTML = `<div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg"><div class="overflow-x-auto"><table class="w-full table-auto text-left text-sm"><thead class="bg-gray-700/50 text-gray-300"><tr><th class="p-3 font-semibold">Compound</th><th class="p-3 font-semibold">Dosage</th><th class="p-3 font-semibold">Frequency</th><th class="p-3 font-semibold">Time of Day</th><th class="p-3 font-semibold">Inj. Amount (units)</th></tr></thead><tbody class="divide-y divide-gray-700">${tableRowsHTML}</tbody></table></div></div>`; }
            }
            function populateLibrary() {
                const libraryGrid = document.getElementById('library-grid'); libraryGrid.innerHTML = '';
                for (const key in appData.protocol) { const compound = appData.protocol[key]; const statusStyles = { research: { icon: '🔬', bg: 'bg-blue-500/20', text: 'text-blue-300' }, experimental: { icon: '🧪', bg: 'bg-purple-500/20', text: 'text-purple-300' }, prescription: { icon: '💊', bg: 'bg-green-500/20', text: 'text-green-300' }, 'prescription-c': { icon: '⚠️', bg: 'bg-red-500/20', text: 'text-red-300' }, supplement: { icon: '🌿', bg: 'bg-emerald-500/20', text: 'text-emerald-300' }, device: { icon: '💡', bg: 'bg-gray-500/20', text: 'text-gray-300' } }; const style = statusStyles[compound.status] || statusStyles['device'];
                const indicatorLine = compound.type === 'therapy' ? '' : `<span class="indicator-line ${compound.type === 'injectable' ? 'indicator-injectable' : 'indicator-oral'}"></span>`;
                const card = `<button data-key="${key}" class="compound-link text-left w-full h-full bg-gray-800 p-4 rounded-lg shadow-lg hover:shadow-xl hover:bg-gray-700/50 transition-all duration-200 flex flex-col justify-between border border-gray-700"><div><h4 class="font-bold text-white flex items-center">${indicatorLine}${compound.name}</h4><p class="text-xs text-gray-400 mb-2">${compound.category}</p><p class="text-sm text-gray-300">${compound.info.Background.substring(0, 100)}...</p></div><div class="mt-3"><span class="text-xs font-semibold px-2 py-1 rounded-full ${style.bg} ${style.text}">${style.icon} ${compound.status.replace('-c', ' (Controlled)')}</span></div></button>`; libraryGrid.innerHTML += card; }
            }
            function populateRiskTable() {
                const riskTableBody = document.getElementById('risk-table'); riskTableBody.innerHTML = '';
                for (const key in appData.protocol) { const compound = appData.protocol[key]; if (!compound.risk) continue; let nameCellClass = "text-gray-200"; if(compound.status === 'prescription-c') nameCellClass = "text-red-400 font-bold"; if(compound.status === 'research' || compound.status === 'experimental') nameCellClass = "text-blue-400 font-semibold";
                const row = `<tr class="hover:bg-gray-700/50"><td class="p-3 font-medium ${nameCellClass}">${compound.name}</td><td class="p-3 text-gray-300">${compound.risk.status}</td><td class="p-3 text-gray-300">${compound.risk.primary}</td><td class="p-3 text-gray-300">${compound.risk.monitoring}</td></tr>`; riskTableBody.innerHTML += row; }
            }
            function openModal(key) {
                const compound = appData.protocol[key]; 
                const indicatorLine = compound.type === 'therapy' ? '' : `<span class="indicator-line ${compound.type === 'injectable' ? 'indicator-injectable' : 'indicator-oral'}"></span>`;
                modalTitle.innerHTML = `${indicatorLine}${compound.name}`;
                let infoHtml = '';
                for (const sectionTitle in compound.info) {
                    infoHtml += `<h4 class="font-bold text-lg text-white mb-2 mt-4">${sectionTitle}</h4><p class="text-gray-300 text-sm">${compound.info[sectionTitle]}</p>`;
                }
                modalBody.innerHTML = infoHtml;
                modal.classList.remove('invisible', 'opacity-0'); modalContent.classList.remove('scale-95');
            }
            function closeModal() { modal.classList.add('invisible', 'opacity-0'); modalContent.classList.add('scale-95'); }
            function setupProtocolEventListeners() {
                const phaseTabs = document.querySelectorAll('.phase-tab'); const phaseContents = document.querySelectorAll('.protocol-phase-content');
                phaseTabs.forEach(tab => { tab.addEventListener('click', () => { phaseTabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); phaseContents.forEach(content => content.classList.add('hidden')); document.getElementById(`protocol-${tab.dataset.phase}`).classList.remove('hidden'); }); });
                document.querySelectorAll('#protocol-view .compound-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); openModal(link.dataset.key); }); });
            }
            function handleTabSwitching() {
                document.querySelectorAll('.main-tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active')); tab.classList.add('active'); document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden')); document.getElementById(`${tab.dataset.tab}-view`).classList.remove('hidden'); }); });
            }
            
            function initializeLogView() {
                const logContainer = document.getElementById('log-container');
                logContainer.innerHTML = '';
                const { startDate: start, endDate: end } = appData.checklist;
                const startDate = new Date(start + 'T00:00:00');
                const endDate = new Date(end + 'T00:00:00');
                let currentDate = new Date(startDate);
                let dayCounter = 0;

                while(currentDate <= endDate) {
                    const dayIndex = `day-${dayCounter}`;
                    const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    
                    const logCard = document.createElement('div');
                    logCard.className = 'bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col space-y-4';
                    logCard.id = `log-${dayIndex}`;
                    logCard.innerHTML = `
                        <div>
                            <h3 class="font-bold text-lg text-white">${dateString}</h3>
                            <div id="log-display-${dayIndex}" class="mt-2 text-sm text-gray-400">No entry for this day.</div>
                        </div>
                        <div id="log-form-${dayIndex}" class="log-entry-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-semibold text-gray-300 text-sm">Overall Feeling:</label>
                                    <div data-metric="feeling" class="flex justify-around items-center text-2xl mt-2">
                                        <span data-value="1" class="rating-emoji">😞</span>
                                        <span data-value="2" class="rating-emoji">😐</span>
                                        <span data-value="3" class="rating-emoji">🙂</span>
                                        <span data-value="4" class="rating-emoji">😊</span>
                                        <span data-value="5" class="rating-emoji">😁</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-300 text-sm">Swelling / Inflammation:</label>
                                    <div data-metric="swelling" class="flex justify-between items-center mt-2 space-x-1">
                                        <div data-value="1" class="rating-bar flex-1 h-3 bg-gray-600 rounded-l-lg"></div>
                                        <div data-value="2" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="3" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="4" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="5" class="rating-bar flex-1 h-3 bg-gray-600 rounded-r-lg"></div>
                                    </div>
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-300 text-sm">Scar Appearance:</label>
                                    <div data-metric="scar" class="flex justify-between items-center mt-2 space-x-1">
                                        <div data-value="1" class="rating-bar flex-1 h-3 bg-gray-600 rounded-l-lg"></div>
                                        <div data-value="2" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="3" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="4" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="5" class="rating-bar flex-1 h-3 bg-gray-600 rounded-r-lg"></div>
                                    </div>
                                </div>
                                <div>
                                    <label for="notes-${dayIndex}" class="font-semibold text-gray-300 text-sm">Notes:</label>
                                    <textarea id="notes-${dayIndex}" class="w-full bg-gray-700 text-gray-200 rounded-md p-2 mt-2 h-24 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <button data-dayindex="${dayIndex}" class="save-log-btn w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Log</button>
                            </div>
                        </div>
                        <button data-dayindex="${dayIndex}" class="toggle-log-form-btn mt-auto text-sm text-blue-400 hover:text-blue-300 self-start">Add / Edit Log</button>
                    `;
                    logContainer.appendChild(logCard);
                    currentDate.setDate(currentDate.getDate() + 1);
                    dayCounter++;
                }
                setupLogEventListeners();
            }

            function setupLogEventListeners() {
                document.querySelectorAll('.toggle-log-form-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const form = document.getElementById(`log-form-${btn.dataset.dayindex}`);
                        form.classList.toggle('open');
                        btn.textContent = form.classList.contains('open') ? 'Close' : 'Add / Edit Log';
                    });
                });

                document.querySelectorAll('.rating-emoji').forEach(emoji => {
                    emoji.addEventListener('click', () => {
                        const parent = emoji.parentElement;
                        parent.querySelectorAll('.rating-emoji').forEach(e => e.classList.remove('selected'));
                        emoji.classList.add('selected');
                        parent.dataset.rating = emoji.dataset.value;
                    });
                });

                document.querySelectorAll('[data-metric] .rating-bar').forEach(bar => {
                    bar.addEventListener('click', () => {
                        const parent = bar.parentElement;
                        const value = bar.dataset.value;
                        const bars = parent.querySelectorAll('.rating-bar');
                        const colors = ['bg-green-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-500', 'bg-red-700'];
                        
                        bars.forEach((b, i) => {
                            if (i < value) {
                                b.className = `rating-bar flex-1 h-3 ${colors[i]} transition-colors`;
                            } else {
                                b.className = 'rating-bar flex-1 h-3 bg-gray-600 transition-colors';
                            }
                        });
                        bars[0].classList.add('rounded-l-lg');
                        bars[bars.length - 1].classList.add('rounded-r-lg');

                        parent.dataset.rating = value;
                    });
                });

                document.querySelectorAll('.save-log-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const dayIndex = btn.dataset.dayindex;
                        const form = document.getElementById(`log-form-${dayIndex}`);
                        const logData = {
                            feeling: form.querySelector('[data-metric="feeling"]').dataset.rating || null,
                            swelling: form.querySelector('[data-metric="swelling"]').dataset.rating || null,
                            scar: form.querySelector('[data-metric="scar"]').dataset.rating || null,
                            notes: form.querySelector(`#notes-${dayIndex}`).value,
                            timestamp: new Date().toISOString()
                        };
                        updateLogStateInFirestore(dayIndex, logData);
                         form.classList.remove('open');
                         document.querySelector(`.toggle-log-form-btn[data-dayindex="${dayIndex}"]`).textContent = 'Add / Edit Log';
                    });
                });
            }

            function updateLogStateInFirestore(dayIndex, data) {
                 const updateData = { [dayIndex]: data };
                 setDoc(logsDocRef, updateData, { merge: true });
            }

            function updateLogsFromRemote(remoteData) {
                const ratingColors = { '1': 'bg-green-500', '2': 'bg-yellow-500', '3': 'bg-orange-500', '4': 'bg-red-500', '5': 'bg-red-700' };
                const feelingEmojis = { '1': '😞', '2': '😐', '3': '🙂', '4': '😊', '5': '😁' };
                const ratingLabels = { '1': 'Very Low', '2': 'Low', '3': 'Moderate', '4': 'High', '5': 'Very High' };

                for (const dayIndex in remoteData) {
                    const logData = remoteData[dayIndex];
                    const displayEl = document.getElementById(`log-display-${dayIndex}`);
                    const formEl = document.getElementById(`log-form-${dayIndex}`);

                    if (displayEl) {
                        if (logData && logData.timestamp) {
                            let displayHTML = '<ul class="space-y-1">';
                            if (logData.feeling) displayHTML += `<li>Feeling: <span class="text-xl">${feelingEmojis[logData.feeling]}</span></li>`;
                            if (logData.swelling) displayHTML += `<li>Swelling: <span class="font-semibold text-gray-200">${ratingLabels[logData.swelling]}</span></li>`;
                            if (logData.scar) displayHTML += `<li>Scar Appearance: <span class="font-semibold text-gray-200">${ratingLabels[logData.scar]}</span></li>`;
                            if (logData.notes) displayHTML += `<li>Notes: <p class="whitespace-pre-wrap italic text-gray-400">${logData.notes}</p></li>`;
                            displayHTML += '</ul>';
                            displayEl.innerHTML = displayHTML;
                        } else {
                            displayEl.innerHTML = 'No entry for this day.';
                        }
                    }

                    if (formEl && logData) {
                        const feelingContainer = formEl.querySelector('[data-metric="feeling"]');
                        if (logData.feeling) {
                            feelingContainer.dataset.rating = logData.feeling;
                            feelingContainer.querySelectorAll('.rating-emoji').forEach(e => {
                                e.classList.toggle('selected', e.dataset.value === logData.feeling);
                            });
                        }
                        const swellingContainer = formEl.querySelector('[data-metric="swelling"]');
                        if(logData.swelling) {
                             swellingContainer.dataset.rating = logData.swelling;
                             swellingContainer.querySelectorAll('.rating-bar').forEach((b, i) => {
                                 b.className = `rating-bar flex-1 h-3 ${i < logData.swelling ? ratingColors[i+1] : 'bg-gray-600'} transition-colors`;
                             });
                             swellingContainer.querySelector('.rating-bar').classList.add('rounded-l-lg');
                             swellingContainer.querySelector('.rating-bar:last-child').classList.add('rounded-r-lg');
                        }
                         const scarContainer = formEl.querySelector('[data-metric="scar"]');
                        if(logData.scar) {
                             scarContainer.dataset.rating = logData.scar;
                             scarContainer.querySelectorAll('.rating-bar').forEach((b, i) => {
                                 b.className = `rating-bar flex-1 h-3 ${i < logData.scar ? ratingColors[i+1] : 'bg-gray-600'} transition-colors`;
                             });
                             scarContainer.querySelector('.rating-bar').classList.add('rounded-l-lg');
                             scarContainer.querySelector('.rating-bar:last-child').classList.add('rounded-r-lg');
                        }
                        formEl.querySelector(`#notes-${dayIndex}`).value = logData.notes || '';
                    }
                }
            }
            
            modalClose.addEventListener('click', closeModal); modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); }); document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
            
            runApp();
        });
    </script>
</body>
</html>
