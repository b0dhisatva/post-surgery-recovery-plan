<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>David's Recovery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gray-900': '#111827', 'gray-800': '#1F2937', 'gray-700': '#374151',
                        'gray-600': '#4B5563', 'gray-500': '#6B7280', 'gray-400': '#9CA3AF',
                        'gray-300': '#D1D5DB', 'gray-200': '#E5E7EB', 'blue-500': '#3B82F6',
                        'blue-400': '#60A5FA',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #D1D5DB; }
        .main-tab.active, .main-tab:hover { color: #60A5FA; border-bottom-color: #60A5FA; }
        .main-tab { transition: color 0.2s, border-bottom-color 0.2s; border-bottom: 2px solid transparent; }
        .day-card { border-left: 4px solid #3B82F6; } .day-card.phase-2 { border-left-color: #10b981; } .day-card.phase-3 { border-left-color: #8b5cf6; }
        .checkbox-custom { appearance: none; -webkit-appearance: none; height: 1.25rem; width: 1.25rem; border-radius: 0.25rem; border: 2px solid #4B5563; background-color: #374151; cursor: pointer; position: relative; transition: background-color 0.2s, border-color 0.2s; }
        .checkbox-custom:checked { background-color: #3B82F6; border-color: #60A5FA; }
        .checkbox-custom:checked::after { content: '‚úì'; position: absolute; color: white; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1rem; font-weight: bold; }
        .progress-bar-bg { background-color: #374151; }
        .progress-bar-fg { background-color: #3B82F6; transition: width 0.3s ease-in-out; }
        .phase-tab.active { background-color: #3B82F6; color: white; }
        .modal { transition: opacity 0.25s ease, visibility 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        #app-loader { transition: opacity 0.3s ease-in-out; }
        .rating-emoji { transition: transform 0.2s, filter 0.2s; cursor: pointer; filter: grayscale(80%); transform: scale(1); }
        .rating-emoji.selected, .rating-emoji:hover { filter: grayscale(0%); transform: scale(1.15); }
        .rating-bar { transition: background-color 0.2s; cursor: pointer; }
        .log-entry-form { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
        .log-entry-form.open { max-height: 500px; padding-top: 1rem; padding-bottom: 1rem; }
        .indicator-line { width: 3px; height: 1rem; border-radius: 9999px; display: inline-block; margin-right: 0.375rem; vertical-align: middle; }
        .indicator-injectable { background-color: #60A5FA; }
        .indicator-oral { background-color: #D1D5DB; }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">
    
    <!-- App Loader -->
    <div id="app-loader" class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center">
         <svg class="animate-spin h-8 w-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
         <p id="loader-text" class="mt-4 text-lg text-gray-300">Connecting to Hub...</p>
    </div>

    <!-- Main App Content (hidden by default) -->
    <div id="main-app" class="hidden">
        <header class="bg-gray-800 shadow-lg sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-white mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                        </svg>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-white">David's Recovery Hub</h1>
                            <p class="text-sm text-gray-400">July 12, 2025 - September 30, 2025</p>
                        </div>
                    </div>
                    <nav class="flex items-center space-x-6 mt-4 sm:mt-0">
                        <button data-tab="checklist" class="main-tab font-medium text-gray-300 px-1 py-2 text-base active">Daily Checklist</button>
                        <button data-tab="log" class="main-tab font-medium text-gray-300 px-1 py-2 text-base">Log</button>
                        <button data-tab="protocol" class="main-tab font-medium text-gray-300 px-1 py-2 text-base">Full Protocol</button>
                    </nav>
                </div>
                 <div class="flex items-center space-x-4 text-xs text-gray-400 pt-2 pb-2">
                    <span>Legend:</span>
                    <div class="flex items-center"><span class="indicator-line indicator-injectable"></span>Injectable</div>
                    <div class="flex items-center"><span class="indicator-line indicator-oral"></span>Oral</div>
                </div>
            </div>
        </header>

        <main class="container mx-auto">
            <div id="checklist-view" class="tab-content">
                <div class="px-4 sm:px-6 lg:px-8 pt-6">
                    <div class="flex items-center space-x-4 text-sm text-gray-400">
                        <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-blue-500 mr-2"></div><span>Phase I</span></div>
                        <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-emerald-500 mr-2"></div><span>Phase II</span></div>
                        <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-violet-500 mr-2"></div><span>Phase III</span></div>
                    </div>
                </div>
                <div id="checklist-container" class="p-4 sm:p-6 lg:p-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="log-view" class="tab-content hidden">
                 <div id="log-container" class="p-4 sm:p-6 lg:p-8 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </div>

            <div id="protocol-view" class="tab-content hidden p-4 sm:p-6 lg:p-8">
                <section id="protocol" class="mb-16 scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Integrated Protocol Timeline</h2>
                    <p class="mb-6 text-gray-400 max-w-3xl">This section presents the core of your recovery plan...</p>
                    <div class="mb-6"><div class="flex flex-wrap border-b border-gray-700">
                            <button data-phase="phase1" class="phase-tab px-4 py-2 font-medium text-gray-300 hover:bg-gray-700 active">Phase I (Wk 1-2)</button>
                            <button data-phase="phase2" class="phase-tab px-4 py-2 font-medium text-gray-300 hover:bg-gray-700">Phase II (Wk 3-6)</button>
                            <button data-phase="phase3" class="phase-tab px-4 py-2 font-medium text-gray-300 hover:bg-gray-700">Phase III (Wk 7-11)</button>
                    </div></div>
                    <div id="protocol-phase1" class="protocol-phase-content"></div>
                    <div id="protocol-phase2" class="protocol-phase-content hidden"></div>
                    <div id="protocol-phase3" class="protocol-phase-content hidden"></div>
                </section>
                <section id="library" class="mb-16 scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Compound Library</h2>
                    <p class="mb-6 text-gray-400 max-w-3xl">Explore the science behind your recovery protocol...</p>
                    <div id="library-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </section>
                <section id="phases" class="mb-16 scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">The 3 Phases of Healing</h2>
                     <p class="mb-8 text-gray-400 max-w-3xl">Your protocol is strategically designed...</p>
                    <div class="relative w-full"><div class="absolute left-0 top-1/2 w-full h-1 bg-gray-700 -translate-y-1/2"></div><div class="relative flex justify-between items-start">
                            <div class="w-1/3 text-center px-2"><div class="relative mb-2"><div class="w-4 h-4 rounded-full bg-blue-500 mx-auto ring-4 ring-gray-900"></div></div><h3 class="font-bold text-blue-400">1. Inflammation</h3><p class="text-xs text-gray-500 mb-2">Day 1 - 7</p><p class="text-xs text-gray-400">The body's first response...</p></div>
                            <div class="w-1/3 text-center px-2"><div class="relative mb-2"><div class="w-4 h-4 rounded-full bg-emerald-500 mx-auto ring-4 ring-gray-900"></div></div><h3 class="font-bold text-emerald-400">2. Proliferation</h3><p class="text-xs text-gray-500 mb-2">Day 4 - Week 6</p><p class="text-xs text-gray-400">Focuses on rebuilding...</p></div>
                            <div class="w-1/3 text-center px-2"><div class="relative mb-2"><div class="w-4 h-4 rounded-full bg-violet-500 mx-auto ring-4 ring-gray-900"></div></div><h3 class="font-bold text-violet-400">3. Remodeling</h3><p class="text-xs text-gray-500 mb-2">Week 4+</p><p class="text-xs text-gray-400">The new tissue is reorganized...</p></div>
                    </div></div>
                </section>
                <section id="risks" class="scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Risk & Safety Center</h2>
                     <p class="mb-6 text-gray-400 max-w-3xl">This section consolidates the critical risk information...</p>
                    <div class="bg-rose-900/50 border border-rose-500/30 text-rose-300 p-4 rounded-lg mb-6"><h3 class="font-bold text-rose-200">‚ö†Ô∏è Critical Disclaimer</h3><p class="text-sm">This protocol is for informational purposes ONLY...</p></div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg"><div class="overflow-x-auto">
                        <table class="w-full table-auto text-left text-sm"><thead class="bg-gray-700/50 text-gray-300"><tr>
                            <th class="p-3 font-semibold">Compound</th><th class="p-3 font-semibold">FDA Status</th><th class="p-3 font-semibold">Primary Risks</th><th class="p-3 font-semibold">Monitoring / Contraindications</th>
                        </tr></thead><tbody id="risk-table" class="divide-y divide-gray-700"></tbody></table>
                    </div></div>
                </section>
            </div>
        </main>
        <div id="compound-modal" class="modal invisible opacity-0 fixed inset-0 w-full h-full bg-black/80 flex items-center justify-center p-4 z-40">
            <div class="modal-content bg-gray-800 w-full max-w-2xl max-h-[90vh] rounded-lg shadow-xl border border-gray-700 transform scale-95 overflow-y-auto">
                <div class="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 id="modal-title" class="text-2xl font-bold text-white"></h3>
                    <button id="modal-close" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                </div><div class="p-6"><div id="modal-body"></div></div>
            </div>
        </div>
        <div id="uncheck-confirm-modal" class="modal invisible opacity-0 fixed inset-0 w-full h-full bg-black/80 flex items-center justify-center p-4 z-50">
             <div class="modal-content bg-gray-800 w-full max-w-md rounded-lg shadow-xl border border-gray-700 transform scale-95 p-6 text-center">
                <h3 class="text-xl font-bold text-white mb-4">Confirm Action</h3>
                <p class="text-gray-300 mb-6">Are you sure you want to mark this item as incomplete? This action will be synced for all users.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-uncheck" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancel</button>
                    <button id="confirm-uncheck" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyBvOuLfBr1-faAK7RC5QkgD6hxhD9oWaP0",
                authDomain: "post-surgery-recovery-plan.firebaseapp.com",
                projectId: "post-surgery-recovery-plan",
                storageBucket: "post-surgery-recovery-plan.appspot.com",
                messagingSenderId: "640490803020",
                appId: "1:640490803020:web:07a9a0322792daff0d89e9",
                measurementId: "G-R4BG49JC7N"
            };

            const appData = {
                checklist: { startDate: '2025-07-12', endDate: '2025-09-30', phases: [{ name: "Phase I", start: 0, end: 13, class: 'day-card' },{ name: "Phase II", start: 14, end: 41, class: 'phase-2' },{ name: "Phase III", start: 42, end: 80, class: 'phase-3' }], items: { "bpc-157": { key: "bpc-157", name: "BPC-157", type: 'injectable', dose: "400mcg", inj: "12 IU", time: "AM", freq: "daily", phases: [1, 2, 3] }, "bpc-157-pm": { key: "bpc-157", name: "BPC-157", type: 'injectable', dose: "400mcg", inj: "12 IU", time: "PM", freq: "daily", phases: [1, 2, 3] }, "tb-500": { key: "tb-500", name: "TB-500", type: 'injectable', dose: "1mg", inj: "60 IU", time: "Any", freq: "daily", phases: [1, 2, 3] }, "kpv": { key: "kpv", name: "KPV", type: 'injectable', dose: "400mcg", inj: "12 IU", time: "AM", freq: "daily", phases: [1] }, "kpv-pm": { key: "kpv", name: "KPV", type: 'injectable', dose: "400mcg", inj: "12 IU", time: "PM", freq: "daily", phases: [1] }, "oxandrolone": { key: "oxandrolone", name: "Anavar", type: 'oral', dose: "6.25mg", time: "AM", freq: "daily", phases: [1, 2, 3] }, "oxandrolone-pm": { key: "oxandrolone", name: "Anavar", type: 'oral', dose: "6.25mg", time: "PM", freq: "daily", phases: [1, 2, 3] }, "collagen": { key: "collagen", name: "Collagen", type: 'oral', dose: "15g", time: "AM", freq: "daily", phases: [1, 2, 3] }, "collagen-pm": { key: "collagen", name: "Collagen", type: 'oral', dose: "15g", time: "PM", freq: "daily", phases: [1, 2, 3] }, "vit-c": { key: "vit-c", name: "Vit C", type: 'oral', dose: "1g", time: "AM Meal", freq: "daily", phases: [1, 2, 3] }, "vit-c-pm": { key: "vit-c", name: "Vit C", type: 'oral', dose: "1g", time: "PM Meal", freq: "daily", phases: [1, 2, 3] }, "vit-d": { key: "vit-d", name: "Vit D3", type: 'oral', dose: "5,000 IU", time: "With Meal", freq: "daily", phases: [1, 2, 3] }, "ha-oral": { key: "ha", name: "Hyaluronic Acid", type: 'oral', dose: "200mg", time: "Any", freq: "daily", phases: [1, 2, 3] }, "ghk-cu": { key: "ghk-cu", name: "GHK-Cu", type: 'injectable', dose: "1mg", inj: "4 IU", time: "PM", freq: "daily", phases: [2, 3] }, "hgh": { key: "hgh", name: "HGH", type: 'injectable', dose: "1.5 IU", inj: "11 IU", time: "AM", freq: "daily", phases: [2, 3] }, "hgh-pm": { key: "hgh", name: "HGH", type: 'injectable', dose: "1.5 IU", inj: "11 IU", time: "PM", freq: "daily", phases: [2, 3] }, "rlt": { key: "rlt", name: "Red Light Therapy", type: 'therapy', dose: "10-15 min", time: "Any", freq: "eod", phases: [2, 3] }, "retatrutide-p2": { key: "retatrutide", name: "Retatrutide", type: 'injectable', dose: "2mg", inj: "60 IU", time: "Any", freq: "weekly", phases: [2], startWeek: 3 }, "retatrutide-p3": { key: "retatrutide", name: "Retatrutide", type: 'injectable', dose: "4mg", inj: "120 IU (split)", time: "Any", freq: "weekly", phases: [3] } } },
                protocol: { "bpc-157": { name: "BPC-157", type: 'injectable', category: "Peptide", status: "research", info: { summary: 'A synthetic peptide derived from a protein in gastric juice, known for its potent, localized tissue-regenerative properties.', mechanism: 'Primarily works by promoting angiogenesis (new blood vessel formation), which enhances delivery of oxygen and nutrients to the wound. It also stimulates the migration and proliferation of fibroblasts, the cells responsible for producing collagen.', notes: 'Subcutaneous injection near (but not in) incisions is the most effective method for localized skin healing. Its expression of growth hormone receptors may amplify the effects of HGH.' }, phases: { phase1: { dosage: "400 mcg (800mcg/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "12 IU" }, phase2: { dosage: "400 mcg (800mcg/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "12 IU" }, phase3: { dosage: "400 mcg (800mcg/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "12 IU" } }, risk: { status: "Unapproved drug; not for human use.", primary: "Lack of long-term human safety data; significant sourcing risks (purity, contaminants). Reported side effects are generally mild: nausea, fatigue, dizziness.", monitoring: "Unknown long-term effects." } }, "tb-500": { name: "TB-500", type: 'injectable', category: "Peptide", status: "research", info: { summary: 'The synthetic form of Thymosin Beta-4 (TŒ≤4), a naturally occurring peptide that promotes systemic (whole-body) repair.', mechanism: 'Upregulates a cellular building block called actin, which is fundamental to cell migration, differentiation, and proliferation. It acts as a system-wide signal to attract repair cells to injury sites. Also promotes angiogenesis and has anti-inflammatory properties.', notes: 'Administered subcutaneously. A consistent daily dose provides steady systemic levels for ongoing support.' }, phases: { phase1: { dosage: "1.0 mg", freq: "Once Daily", time: "Any", injectionAmount: "60 IU" }, phase2: { dosage: "1.0 mg", freq: "Once Daily", time: "Any", injectionAmount: "60 IU" }, phase3: { dosage: "1.0 mg", freq: "Once Daily", time: "Any", injectionAmount: "60 IU" } }, risk: { status: "Unapproved drug; not for human use.", primary: "Lack of long-term human safety data. Its potent angiogenic properties mean it could theoretically promote tumor growth.", monitoring: "Contraindicated in individuals with a history of or active cancer." } }, "ghk-cu": { name: "GHK-Cu (Injectable)", type: 'injectable', category: "Peptide", status: "research", info: { summary: 'A naturally occurring copper peptide complex that plays a key role in dermal remodeling. Injectable form provides systemic support for tissue regeneration.', mechanism: 'Regulates the synthesis and breakdown of extracellular matrix (ECM) components. It stimulates production of healthy collagen and elastin while also helping to remove damaged proteins and disorganized scar tissue. It can also modulate gene expression, shifting cells towards a more regenerative state.', notes: 'Introduced in Phase II, once the initial inflammatory phase has subsided, to guide the remodeling process. Systemic administration supports widespread tissue health.' }, phases: { phase2: { dosage: "1.0 mg", freq: "Once Daily", time: "Evening", injectionAmount: "4 IU" }, phase3: { dosage: "1.0 mg", freq: "Once Daily", time: "Evening", injectionAmount: "4 IU" } }, risk: { status: "Unapproved drug; not for human use.", primary: "Lack of human safety data. Potential for injection site reactions, flushing, or nausea. Systemic copper administration carries risks.", monitoring: "Contraindicated in individuals with copper metabolism disorders (e.g., Wilson's disease)." } }, "kpv": { name: "KPV", type: 'injectable', category: "Peptide", status: "research", info: { summary: 'A tripeptide fragment of Œ±-MSH, it is one of the most potent anti-inflammatory peptides known, used here to precisely control the initial post-surgical inflammatory cascade.', mechanism: 'Acts intracellularly to inhibit key inflammatory signaling pathways (like NF-Œ∫B). This prevents the over-production of pro-inflammatory cytokines, allowing for necessary inflammation without causing excessive pain, swelling, or collateral tissue damage. It also has antimicrobial properties.', notes: 'Administered via subcutaneous injection for systemic anti-inflammatory benefits. It is introduced immediately post-op to manage Phase I healing.' }, phases: { phase1: { dosage: "400 mcg (800mcg/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "12 IU" } }, risk: { status: "Unapproved peptide; not for human use.", primary: "Lack of human safety data. Reported side effects are typically mild, such as minor GI or skin reactions.", monitoring: "Unknown long-term effects." } }, "hgh": { name: "HGH", type: 'injectable', category: "Hormone", status: "prescription", info: { summary: 'Human Growth Hormone (somatropin) is a master regenerative hormone that creates a powerful systemic drive towards healing.', mechanism: 'Stimulates production of IGF-1, which in turn drives cell growth, repair, and proliferation throughout the body. It is a potent stimulator of collagen synthesis, providing the raw material for strong new tissue.', notes: 'Introduced in Phase II once the acute critical phase of surgery is over. Splitting the dose into AM/PM injections can help maintain more stable levels and may reduce side effects.' }, phases: { phase2: { dosage: "1.5 IU (3 IU/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "11 IU" }, phase3: { dosage: "1.5 IU (3 IU/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "11 IU" } }, risk: { status: "Prescription drug. Off-label distribution is illegal.", primary: "Edema (fluid retention), arthralgia (joint pain), carpal tunnel syndrome, impaired glucose tolerance.", monitoring: "Contraindicated in acute critical illness post-surgery and in active cancer. Must be prescribed and monitored by a physician." } }, "retatrutide": { name: "Retatrutide", type: 'injectable', category: "Peptide", status: "experimental", info: { summary: 'A novel, experimental triple-receptor agonist peptide (GLP-1, GIP, glucagon) for profound metabolic optimization and inflammation control.', mechanism: 'By improving insulin sensitivity, lipid profiles, and blood pressure, it ensures energy is partitioned effectively towards tissue repair. It also lowers systemic inflammation, creating an ideal internal environment for healing.', notes: 'Highly experimental. Protocol introduces it at 2mg/wk (late Phase II), increasing to 4mg/wk (Phase III). The 4mg dose exceeds a single 1mL syringe capacity and must be split into two separate injections. Inclusion is speculative and contingent on future availability.' }, phases: { phase2: { dosage: "2 mg", freq: "Weekly (starting Wk 3)", time: "Any", injectionAmount: "60 IU" }, phase3: { dosage: "4 mg", freq: "Weekly", time: "Any", injectionAmount: "120 IU (split)" } }, risk: { status: "Investigational new drug (in clinical trials).", primary: "Common side effects in trials include nausea and other GI issues. Long-term safety is unknown.", monitoring: "Not legally available for use outside of sanctioned clinical trials." } }, "oxandrolone": { name: "Oxandrolone", type: 'oral', category: "Anabolic Agent", status: "prescription-c", info: { summary: 'An oral anabolic-androgenic steroid (AAS) with a highly favorable anabolic profile, used to aggressively counteract the catabolic (tissue breakdown) state induced by surgical trauma.', mechanism: 'Directly stimulates protein synthesis and inhibits protein breakdown, leading to a positive nitrogen balance essential for preserving and rebuilding lean body mass. Clinical studies in trauma patients show it accelerates wound healing.', notes: 'A Schedule III controlled substance. The total daily dose of 12.5mg is split to maintain stable blood levels.' }, phases: { phase1: { dosage: "6.25 mg (12.5mg/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "‚Äî" }, phase2: { dosage: "6.25 mg (12.5mg/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "‚Äî" }, phase3: { dosage: "6.25 mg (12.5mg/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "‚Äî" } }, risk: { status: "Schedule III prescription drug.", primary: "Hepatotoxicity (liver damage) and severe dyslipidemia (adverse changes in cholesterol).", monitoring: "MANDATORY bloodwork to monitor liver enzymes (AST/ALT) and a full lipid panel is required before, during, and after the cycle." } }, "collagen": { name: "Multi-Collagen Powder", type: 'oral', category: "Supplement", status: "supplement", info: { summary: 'Provides the direct raw materials (amino acids like glycine, proline) needed for the body to construct its own new collagen.', mechanism: 'Supplies the specific building blocks for Type I and Type III collagen, the predominant types in the skin, supporting the formation of a strong, healthy dermal matrix.', notes: 'Use a hydrolyzed powder for best absorption. The 30g daily dose is split to improve absorption and provide a steady supply of amino acids.' }, phases: { phase1: { dosage: "15 g (30g/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "‚Äî" }, phase2: { dosage: "15 g (30g/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "‚Äî" }, phase3: { dosage: "15 g (30g/day)", freq: "Twice Daily", time: "Morning & Evening", injectionAmount: "‚Äî" } }, risk: { status: "Supplement (GRAS)", primary: "Generally very low risk.", monitoring: "Follow recommended dosage." } }, "vit-c": { name: "Vitamin C", type: 'oral', category: "Supplement", status: "supplement", info: { summary: 'An essential cofactor for the enzymes that create stable, strong collagen. It is also a potent antioxidant.', mechanism: 'Without adequate Vitamin C, the body cannot form functional collagen, leading to impaired wound healing. It is a non-negotiable component of tissue repair.', notes: 'A high therapeutic dose is warranted post-surgery due to the high demand for collagen synthesis. Take in divided doses.' }, phases: { phase1: { dosage: "1 g (2g/day)", freq: "Twice Daily", time: "With Meals", injectionAmount: "‚Äî" }, phase2: { dosage: "1 g (2g/day)", freq: "Twice Daily", time: "With Meals", injectionAmount: "‚Äî" }, phase3: { dosage: "1 g (2g/day)", freq: "Twice Daily", time: "With Meals", injectionAmount: "‚Äî" } }, risk: { status: "Supplement (GRAS)", primary: "Generally low risk; very high doses can cause GI upset.", monitoring: "Follow recommended dosage." } }, "vit-d": { name: "Vitamin D3", type: 'oral', category: "Supplement", status: "supplement", info: { summary: 'A critical modulator of the immune system and cellular function, essential for healthy healing.', mechanism: 'Helps regulate the proliferation and differentiation of cells in all phases of healing. Deficiency is linked to poorer surgical outcomes.', notes: 'The ideal dosage should be guided by pre-operative blood testing to correct any existing deficiency.' }, phases: { phase1: { dosage: "5,000 IU", freq: "Once Daily", time: "With Meal", injectionAmount: "‚Äî" }, phase2: { dosage: "5,000 IU", freq: "Once Daily", time: "With Meal", injectionAmount: "‚Äî" }, phase3: { dosage: "5,000 IU", freq: "Once Daily", time: "With Meal", injectionAmount: "‚Äî" } }, risk: { status: "Supplement (GRAS)", primary: "Low risk at this dose; toxicity is possible at extremely high, prolonged doses.", monitoring: "Follow recommended dosage." } }, "ha": { name: "Hyaluronic Acid", type: 'oral', category: "Supplement", status: "supplement", info: { summary: 'A major component of the skin\'s extracellular matrix, responsible for hydration, lubrication, and volume.', mechanism: 'Plays an active role in all phases of healing by providing structural support and facilitating cell migration. Oral supplementation supports systemic hydration and tissue quality from within.', notes: 'Can also be applied topically in a serum for additional benefit.' }, phases: { phase1: { dosage: "200 mg", freq: "Once Daily", time: "Any", injectionAmount: "‚Äî" }, phase2: { dosage: "200 mg", freq: "Once Daily", time: "Any", injectionAmount: "‚Äî" }, phase3: { dosage: "200 mg", freq: "Once Daily", time: "Any", injectionAmount: "‚Äî" } }, risk: { status: "Supplement (GRAS)", primary: "Generally very low risk.", monitoring: "Follow recommended dosage." } }, "rlt": { name: "Red Light Therapy", type: 'therapy', category: "Therapy", status: "device", info: { summary: 'A biophysical therapy that uses specific wavelengths of light to stimulate cellular processes non-invasively, acting as a powerful catalyst for healing.', mechanism: 'Light photons are absorbed by mitochondria, which boosts the production of ATP (cellular energy). This extra energy powers all healing processes, including cell proliferation, collagen synthesis, and angiogenesis, while also reducing inflammation.', notes: 'Use a device that provides both red (630-660nm) and near-infrared (810-850nm) wavelengths. Start after initial dressings are removed.' }, phases: { phase2: { dosage: "10-15 min session", freq: "Daily or Every Other Day", time: "Any", injectionAmount: "‚Äî" }, phase3: { dosage: "10-15 min session", freq: "Daily or Every Other Day", time: "Any", injectionAmount: "‚Äî" } }, risk: { status: "FDA-cleared devices exist", primary: "Low risk; potential for skin irritation or eye damage without protection.", monitoring: "Use appropriate eye protection." } } }
            };

            let db;
            let checklistDocRef;
            let logsDocRef;
            let unsubscribeChecklist;
            let unsubscribeLogs;
            let checkboxToUncheck = null;
            
            const mainApp = document.getElementById('main-app');
            const appLoader = document.getElementById('app-loader');
            const loaderText = document.getElementById('loader-text');
            const modal = document.getElementById('compound-modal');
            const uncheckModal = document.getElementById('uncheck-confirm-modal');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalClose = document.getElementById('modal-close');
            const confirmUncheckBtn = document.getElementById('confirm-uncheck');
            const cancelUncheckBtn = document.getElementById('cancel-uncheck');

            function runApp() {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    appLoader.classList.remove('hidden');
                    loaderText.textContent = "Firebase config missing in HTML file.";
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                checklistDocRef = doc(db, "recoveryState", "checklist");
                logsDocRef = doc(db, "recoveryState", "logs");

                startApp();
            }

            async function startApp() {
                appLoader.classList.remove('hidden');
                initializeProtocolView();
                initializeChecklist();
                initializeLogView();
                handleTabSwitching();
                setupUncheckModalListeners();
                
                unsubscribeChecklist = onSnapshot(checklistDocRef, (docSnap) => {
                    const remoteData = docSnap.exists() ? docSnap.data() : {};
                    updateCheckboxesFromRemote(remoteData);
                });
                
                unsubscribeLogs = onSnapshot(logsDocRef, (docSnap) => {
                    const remoteData = docSnap.exists() ? docSnap.data() : {};
                    updateLogsFromRemote(remoteData);
                });

                appLoader.classList.add('opacity-0', 'pointer-events-none');
                mainApp.classList.remove('hidden');
            }
            
            function updateCheckboxStateInFirestore(id, data) {
                 const updateData = { [id]: data };
                 setDoc(checklistDocRef, updateData, { merge: true });
            }
            
            function updateCheckboxesFromRemote(remoteData) {
                document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(checkbox => {
                    const checkboxData = remoteData[checkbox.id];
                    const shouldBeChecked = checkboxData && checkboxData.checked === true;
                    
                    if (checkbox.checked !== shouldBeChecked) {
                        checkbox.checked = shouldBeChecked;
                    }

                    const timestampEl = document.getElementById(`ts-${checkbox.id}`);
                    if (shouldBeChecked && checkboxData.ts) {
                        timestampEl.textContent = `Completed: ${checkboxData.ts}`;
                        timestampEl.classList.remove('hidden');
                    } else {
                        timestampEl.textContent = '';
                        timestampEl.classList.add('hidden');
                    }

                    const dayCard = checkbox.closest('.day-card');
                    if(dayCard) updateDayProgress(dayCard);
                });
            }

            function updateDayProgress(dayCard) {
                const checkboxes = dayCard.querySelectorAll('input[type="checkbox"]');
                const progressBar = dayCard.querySelector('.progress-bar-fg');
                if (!progressBar) return;
                const totalCheckboxes = checkboxes.length;
                const checkedCount = dayCard.querySelectorAll('input[type="checkbox"]:checked').length;
                const progressPercentage = totalCheckboxes > 0 ? (checkedCount / totalCheckboxes) * 100 : 0;
                progressBar.style.width = `${progressPercentage}%`;
            }

            function handleCheckboxClick(e) {
                const checkbox = e.target;
                if (checkbox.checked) {
                    const timestamp = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    updateCheckboxStateInFirestore(checkbox.id, { checked: true, ts: timestamp });
                } else {
                    e.preventDefault();
                    checkboxToUncheck = checkbox;
                    uncheckModal.classList.remove('invisible', 'opacity-0');
                }
            }
            
            function setupUncheckModalListeners() {
                function closeUncheckModal() {
                    uncheckModal.classList.add('invisible', 'opacity-0');
                    if (checkboxToUncheck) {
                         checkboxToUncheck = null;
                    }
                }
                
                cancelUncheckBtn.addEventListener('click', closeUncheckModal);
                uncheckModal.addEventListener('click', (e) => {
                    if (e.target === uncheckModal) closeUncheckModal();
                });

                confirmUncheckBtn.addEventListener('click', () => {
                    if (checkboxToUncheck) {
                        updateCheckboxStateInFirestore(checkboxToUncheck.id, { checked: false, ts: null });
                    }
                    closeUncheckModal();
                });
            }

            function initializeChecklist() {
                const checklistContainer = document.getElementById('checklist-container');
                checklistContainer.innerHTML = '';
                const { startDate: start, endDate: end, phases, items } = appData.checklist;
                const startDate = new Date(start + 'T00:00:00');
                const endDate = new Date(end + 'T00:00:00');
                let currentDate = new Date(startDate);
                let dayCounter = 0;
                let dayOfWeekCounter = currentDate.getDay();

                const timeSortOrder = { 'AM': 1, 'AM Meal': 1, 'Any': 2, 'With Meal': 2, 'Evening': 3, 'PM': 3, 'PM Meal': 3 };

                while (currentDate <= endDate) {
                    const dayIndex = dayCounter;
                    const currentPhaseInfo = phases.find(p => dayIndex >= p.start && dayIndex <= p.end);
                    const currentPhaseNumber = phases.indexOf(currentPhaseInfo) + 1;
                    const dayCard = document.createElement('div');
                    dayCard.className = `day-card ${currentPhaseInfo.class} bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col`;
                    dayCard.id = `day-${dayIndex}`;
                    const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    
                    let itemsForDay = [];
                    for (const key in items) {
                        const item = items[key];
                        if (item.phases.includes(currentPhaseNumber)) {
                            let shouldAdd = false;
                            if(item.freq === 'daily' || (item.freq === 'eod' && dayIndex % 2 === 0) ) {
                               shouldAdd = true;
                            } else if (item.freq === 'weekly' && dayOfWeekCounter % 7 === 0) {
                                 shouldAdd = true;
                                 if(item.startWeek) {
                                    const phaseStartDate = new Date(start);
                                    phaseStartDate.setDate(phaseStartDate.getDate() + currentPhaseInfo.start);
                                    const itemStartDate = new Date(phaseStartDate);
                                    itemStartDate.setDate(itemStartDate.getDate() + (item.startWeek - 1) * 7);
                                    if(currentDate < itemStartDate) shouldAdd = false;
                               }
                            }
                            if(shouldAdd) itemsForDay.push({ ...item, checklistKey: key });
                        }
                    }

                    itemsForDay.sort((a, b) => (timeSortOrder[a.time] || 99) - (timeSortOrder[b.time] || 99));

                    let checklistHTML = itemsForDay.map(item => {
                        const id = `check-${dayIndex}-${item.checklistKey}`;
                        const injText = item.inj ? `<span class="font-mono text-xs text-blue-400">${item.inj}</span>` : '';
                        const indicatorLine = item.type === 'therapy' ? '' : `<span class="indicator-line ${item.type === 'injectable' ? 'indicator-injectable' : 'indicator-oral'}"></span>`;
                        return `<div class="flex items-center justify-between py-2 border-b border-gray-700 last:border-b-0">
                                <label class="flex items-start cursor-pointer flex-grow mr-2">
                                    <input type="checkbox" id="${id}" class="checkbox-custom mr-3 flex-shrink-0 mt-1">
                                    <div class="min-w-0">
                                        <div>
                                            ${indicatorLine}
                                            <span class="font-medium text-gray-200">${item.name}</span>
                                            <span class="text-sm text-gray-400 ml-2">${item.dose}</span>
                                        </div>
                                        <div id="ts-${id}" class="text-xs text-blue-400 mt-1 hidden ml-7"></div>
                                    </div>
                                </label>
                                ${injText}<span class="text-sm text-gray-500 ml-auto pl-2 text-right self-start mt-1">${item.time}</span></div>`;
                    }).join('');

                    dayCard.innerHTML = `<div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-white">${dateString}</h3>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${currentPhaseInfo.class === 'day-card' ? 'bg-blue-500/20 text-blue-300' : currentPhaseInfo.class === 'phase-2' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-violet-500/20 text-violet-300'}">${currentPhaseInfo.name}</span>
                        </div><div class="flex-grow">${checklistHTML || '<p class="text-gray-500 text-sm py-2">Rest day from scheduled therapies.</p>'}</div>
                        <div class="mt-4"><div class="progress-bar-bg w-full h-2 rounded-full overflow-hidden"><div class="progress-bar-fg h-full" style="width: 0%;"></div></div></div>`;
                    checklistContainer.appendChild(dayCard);
                    
                    dayCard.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('click', handleCheckboxClick);
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                    dayCounter++;
                    dayOfWeekCounter++;
                }
            }
            
            function initializeProtocolView() {
                 populateProtocolTables(); populateLibrary(); populateRiskTable(); setupProtocolEventListeners();
            }
            function populateProtocolTables() {
                const { protocol } = appData; const phaseContainers = { phase1: document.getElementById('protocol-phase1'), phase2: document.getElementById('protocol-phase2'), phase3: document.getElementById('protocol-phase3'), };
                for (const phase in phaseContainers) { let tableRowsHTML = ''; for (const key in protocol) { const compound = protocol[key]; if (compound.phases[phase]) { const pData = compound.phases[phase];
                const indicatorLine = compound.type === 'therapy' ? '' : `<span class="indicator-line ${compound.type === 'injectable' ? 'indicator-injectable' : 'indicator-oral'}"></span>`;
                tableRowsHTML += `<tr class="hover:bg-gray-700/50"><td class="p-3 font-medium"><button data-key="${key}" class="compound-link text-blue-400 hover:text-blue-300 hover:underline">${indicatorLine}${compound.name}</button></td><td class="p-3 text-gray-300">${pData.dosage}</td><td class="p-3 text-gray-300">${pData.freq}</td><td class="p-3 text-gray-300">${pData.time}</td><td class="p-3 text-gray-300 font-mono">${pData.injectionAmount || '‚Äî'}</td></tr>`; } }
                phaseContainers[phase].innerHTML = `<div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg"><div class="overflow-x-auto"><table class="w-full table-auto text-left text-sm"><thead class="bg-gray-700/50 text-gray-300"><tr><th class="p-3 font-semibold">Compound</th><th class="p-3 font-semibold">Dosage</th><th class="p-3 font-semibold">Frequency</th><th class="p-3 font-semibold">Time of Day</th><th class="p-3 font-semibold">Inj. Amount (units)</th></tr></thead><tbody class="divide-y divide-gray-700">${tableRowsHTML}</tbody></table></div></div>`; }
            }
            function populateLibrary() {
                const libraryGrid = document.getElementById('library-grid'); libraryGrid.innerHTML = '';
                for (const key in appData.protocol) { const compound = appData.protocol[key]; const statusStyles = { research: { icon: 'üî¨', bg: 'bg-blue-500/20', text: 'text-blue-300' }, experimental: { icon: 'üß™', bg: 'bg-purple-500/20', text: 'text-purple-300' }, prescription: { icon: 'üíä', bg: 'bg-green-500/20', text: 'text-green-300' }, 'prescription-c': { icon: '‚ö†Ô∏è', bg: 'bg-red-500/20', text: 'text-red-300' }, supplement: { icon: 'üåø', bg: 'bg-emerald-500/20', text: 'text-emerald-300' }, device: { icon: 'üí°', bg: 'bg-gray-500/20', text: 'text-gray-300' } }; const style = statusStyles[compound.status] || statusStyles['device'];
                const indicatorLine = compound.type === 'therapy' ? '' : `<span class="indicator-line ${compound.type === 'injectable' ? 'indicator-injectable' : 'indicator-oral'}"></span>`;
                const card = `<button data-key="${key}" class="compound-link text-left w-full h-full bg-gray-800 p-4 rounded-lg shadow-lg hover:shadow-xl hover:bg-gray-700/50 transition-all duration-200 flex flex-col justify-between border border-gray-700"><div><h4 class="font-bold text-white flex items-center">${indicatorLine}${compound.name}</h4><p class="text-xs text-gray-400 mb-2">${compound.category}</p><p class="text-sm text-gray-300">${compound.info.summary}</p></div><div class="mt-3"><span class="text-xs font-semibold px-2 py-1 rounded-full ${style.bg} ${style.text}">${style.icon} ${compound.status.replace('-c', ' (Controlled)')}</span></div></button>`; libraryGrid.innerHTML += card; }
            }
            function populateRiskTable() {
                const riskTableBody = document.getElementById('risk-table'); riskTableBody.innerHTML = '';
                for (const key in appData.protocol) { const compound = appData.protocol[key]; if (!compound.risk) continue; let nameCellClass = "text-gray-200"; if(compound.status === 'prescription-c') nameCellClass = "text-red-400 font-bold"; if(compound.status === 'research' || compound.status === 'experimental') nameCellClass = "text-blue-400 font-semibold";
                const row = `<tr class="hover:bg-gray-700/50"><td class="p-3 font-medium ${nameCellClass}">${compound.name}</td><td class="p-3 text-gray-300">${compound.risk.status}</td><td class="p-3 text-gray-300">${compound.risk.primary}</td><td class="p-3 text-gray-300">${compound.risk.monitoring}</td></tr>`; riskTableBody.innerHTML += row; }
            }
            function openModal(key) {
                const compound = appData.protocol[key]; modalTitle.textContent = compound.name; let notesHtml = compound.info.notes ? `<div class="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-md"><h5 class="font-semibold text-blue-300">Key Notes</h5><p class="text-sm text-blue-300/80">${compound.info.notes}</p></div>` : '';
                modalBody.innerHTML = `<p class="text-gray-300 mb-4">${compound.info.summary}</p><h4 class="font-bold text-lg text-white mb-2">Mechanism of Action</h4><p class="text-gray-300">${compound.info.mechanism}</p>${notesHtml}`; modal.classList.remove('invisible', 'opacity-0'); modalContent.classList.remove('scale-95');
            }
            function closeModal() { modal.classList.add('invisible', 'opacity-0'); modalContent.classList.add('scale-95'); }
            function setupProtocolEventListeners() {
                const phaseTabs = document.querySelectorAll('.phase-tab'); const phaseContents = document.querySelectorAll('.protocol-phase-content');
                phaseTabs.forEach(tab => { tab.addEventListener('click', () => { phaseTabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); phaseContents.forEach(content => content.classList.add('hidden')); document.getElementById(`protocol-${tab.dataset.phase}`).classList.remove('hidden'); }); });
                document.querySelectorAll('#protocol-view .compound-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); openModal(link.dataset.key); }); });
            }
            function handleTabSwitching() {
                document.querySelectorAll('.main-tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active')); tab.classList.add('active'); document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden')); document.getElementById(`${tab.dataset.tab}-view`).classList.remove('hidden'); }); });
            }
            
            function initializeLogView() {
                const logContainer = document.getElementById('log-container');
                logContainer.innerHTML = '';
                const { startDate: start, endDate: end } = appData.checklist;
                const startDate = new Date(start + 'T00:00:00');
                const endDate = new Date(end + 'T00:00:00');
                let currentDate = new Date(startDate);
                let dayCounter = 0;

                while(currentDate <= endDate) {
                    const dayIndex = `day-${dayCounter}`;
                    const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    
                    const logCard = document.createElement('div');
                    logCard.className = 'bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col space-y-4';
                    logCard.id = `log-${dayIndex}`;
                    logCard.innerHTML = `
                        <div>
                            <h3 class="font-bold text-lg text-white">${dateString}</h3>
                            <div id="log-display-${dayIndex}" class="mt-2 text-sm text-gray-400">No entry for this day.</div>
                        </div>
                        <div id="log-form-${dayIndex}" class="log-entry-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-semibold text-gray-300 text-sm">Overall Feeling:</label>
                                    <div data-metric="feeling" class="flex justify-around items-center text-2xl mt-2">
                                        <span data-value="1" class="rating-emoji">üòû</span>
                                        <span data-value="2" class="rating-emoji">üòê</span>
                                        <span data-value="3" class="rating-emoji">üôÇ</span>
                                        <span data-value="4" class="rating-emoji">üòä</span>
                                        <span data-value="5" class="rating-emoji">üòÅ</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-300 text-sm">Swelling / Inflammation:</label>
                                    <div data-metric="swelling" class="flex justify-between items-center mt-2 space-x-1">
                                        <div data-value="1" class="rating-bar flex-1 h-3 bg-gray-600 rounded-l-lg"></div>
                                        <div data-value="2" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="3" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="4" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="5" class="rating-bar flex-1 h-3 bg-gray-600 rounded-r-lg"></div>
                                    </div>
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-300 text-sm">Scar Appearance:</label>
                                    <div data-metric="scar" class="flex justify-between items-center mt-2 space-x-1">
                                        <div data-value="1" class="rating-bar flex-1 h-3 bg-gray-600 rounded-l-lg"></div>
                                        <div data-value="2" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="3" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="4" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="5" class="rating-bar flex-1 h-3 bg-gray-600 rounded-r-lg"></div>
                                    </div>
                                </div>
                                <div>
                                    <label for="notes-${dayIndex}" class="font-semibold text-gray-300 text-sm">Notes:</label>
                                    <textarea id="notes-${dayIndex}" class="w-full bg-gray-700 text-gray-200 rounded-md p-2 mt-2 h-24 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <button data-dayindex="${dayIndex}" class="save-log-btn w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Log</button>
                            </div>
                        </div>
                        <button data-dayindex="${dayIndex}" class="toggle-log-form-btn mt-auto text-sm text-blue-400 hover:text-blue-300 self-start">Add / Edit Log</button>
                    `;
                    logContainer.appendChild(logCard);
                    currentDate.setDate(currentDate.getDate() + 1);
                    dayCounter++;
                }
                setupLogEventListeners();
            }

            function setupLogEventListeners() {
                document.querySelectorAll('.toggle-log-form-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const form = document.getElementById(`log-form-${btn.dataset.dayindex}`);
                        form.classList.toggle('open');
                        btn.textContent = form.classList.contains('open') ? 'Close' : 'Add / Edit Log';
                    });
                });

                document.querySelectorAll('.rating-emoji').forEach(emoji => {
                    emoji.addEventListener('click', () => {
                        const parent = emoji.parentElement;
                        parent.querySelectorAll('.rating-emoji').forEach(e => e.classList.remove('selected'));
                        emoji.classList.add('selected');
                        parent.dataset.rating = emoji.dataset.value;
                    });
                });

                document.querySelectorAll('[data-metric] .rating-bar').forEach(bar => {
                    bar.addEventListener('click', () => {
                        const parent = bar.parentElement;
                        const value = bar.dataset.value;
                        const bars = parent.querySelectorAll('.rating-bar');
                        const colors = ['bg-green-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-500', 'bg-red-700'];
                        
                        bars.forEach((b, i) => {
                            if (i < value) {
                                b.className = `rating-bar flex-1 h-3 ${colors[i]} transition-colors`;
                            } else {
                                b.className = 'rating-bar flex-1 h-3 bg-gray-600 transition-colors';
                            }
                        });
                        bars[0].classList.add('rounded-l-lg');
                        bars[bars.length - 1].classList.add('rounded-r-lg');

                        parent.dataset.rating = value;
                    });
                });

                document.querySelectorAll('.save-log-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const dayIndex = btn.dataset.dayindex;
                        const form = document.getElementById(`log-form-${dayIndex}`);
                        const logData = {
                            feeling: form.querySelector('[data-metric="feeling"]').dataset.rating || null,
                            swelling: form.querySelector('[data-metric="swelling"]').dataset.rating || null,
                            scar: form.querySelector('[data-metric="scar"]').dataset.rating || null,
                            notes: form.querySelector(`#notes-${dayIndex}`).value,
                            timestamp: new Date().toISOString()
                        };
                        updateLogStateInFirestore(dayIndex, logData);
                         form.classList.remove('open');
                         document.querySelector(`.toggle-log-form-btn[data-dayindex="${dayIndex}"]`).textContent = 'Add / Edit Log';
                    });
                });
            }

            function updateLogStateInFirestore(dayIndex, data) {
                 const updateData = { [dayIndex]: data };
                 setDoc(logsDocRef, updateData, { merge: true });
            }

            function updateLogsFromRemote(remoteData) {
                const ratingColors = { '1': 'bg-green-500', '2': 'bg-yellow-500', '3': 'bg-orange-500', '4': 'bg-red-500', '5': 'bg-red-700' };
                const feelingEmojis = { '1': 'üòû', '2': 'üòê', '3': 'üôÇ', '4': 'üòä', '5': 'üòÅ' };
                const ratingLabels = { '1': 'Very Low', '2': 'Low', '3': 'Moderate', '4': 'High', '5': 'Very High' };

                for (const dayIndex in remoteData) {
                    const logData = remoteData[dayIndex];
                    const displayEl = document.getElementById(`log-display-${dayIndex}`);
                    const formEl = document.getElementById(`log-form-${dayIndex}`);

                    if (displayEl) {
                        if (logData && logData.timestamp) {
                            let displayHTML = '<ul class="space-y-1">';
                            if (logData.feeling) displayHTML += `<li>Feeling: <span class="text-xl">${feelingEmojis[logData.feeling]}</span></li>`;
                            if (logData.swelling) displayHTML += `<li>Swelling: <span class="font-semibold text-gray-200">${ratingLabels[logData.swelling]}</span></li>`;
                            if (logData.scar) displayHTML += `<li>Scar Appearance: <span class="font-semibold text-gray-200">${ratingLabels[logData.scar]}</span></li>`;
                            if (logData.notes) displayHTML += `<li>Notes: <p class="whitespace-pre-wrap italic text-gray-400">${logData.notes}</p></li>`;
                            displayHTML += '</ul>';
                            displayEl.innerHTML = displayHTML;
                        } else {
                            displayEl.innerHTML = 'No entry for this day.';
                        }
                    }

                    if (formEl && logData) {
                        const feelingContainer = formEl.querySelector('[data-metric="feeling"]');
                        if (logData.feeling) {
                            feelingContainer.dataset.rating = logData.feeling;
                            feelingContainer.querySelectorAll('.rating-emoji').forEach(e => {
                                e.classList.toggle('selected', e.dataset.value === logData.feeling);
                            });
                        }
                        const swellingContainer = formEl.querySelector('[data-metric="swelling"]');
                        if(logData.swelling) {
                             swellingContainer.dataset.rating = logData.swelling;
                             swellingContainer.querySelectorAll('.rating-bar').forEach((b, i) => {
                                 b.className = `rating-bar flex-1 h-3 ${i < logData.swelling ? ratingColors[i+1] : 'bg-gray-600'} transition-colors`;
                             });
                             swellingContainer.querySelector('.rating-bar').classList.add('rounded-l-lg');
                             swellingContainer.querySelector('.rating-bar:last-child').classList.add('rounded-r-lg');
                        }
                         const scarContainer = formEl.querySelector('[data-metric="scar"]');
                        if(logData.scar) {
                             scarContainer.dataset.rating = logData.scar;
                             scarContainer.querySelectorAll('.rating-bar').forEach((b, i) => {
                                 b.className = `rating-bar flex-1 h-3 ${i < logData.scar ? ratingColors[i+1] : 'bg-gray-600'} transition-colors`;
                             });
                             scarContainer.querySelector('.rating-bar').classList.add('rounded-l-lg');
                             scarContainer.querySelector('.rating-bar:last-child').classList.add('rounded-r-lg');
                        }
                        formEl.querySelector(`#notes-${dayIndex}`).value = logData.notes || '';
                    }
                }
            }
            
            modalClose.addEventListener('click', closeModal); modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); }); document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
            
            runApp();
        });
    </script>
</body>
</html>
