<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>David's Recovery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gray-900': '#0a0a0a',
                        'gray-800': '#1a1a1a',
                        'gray-700': '#2a2a2a',
                        'gray-600': '#3a3a3a',
                        'gray-500': '#4a4a4a',
                        'gray-400': '#6a6a6a',
                        'gray-300': '#8a8a8a',
                        'gray-200': '#b0b0b0',
                        'blue-500': '#1a73e8',
                        'blue-400': '#4285f4',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #b0b0b0; }
        .main-tab.active, .main-tab:hover { color: #4285f4; border-bottom-color: #4285f4; }
        .main-tab { transition: color 0.2s, border-bottom-color 0.2s; border-bottom: 2px solid transparent; }
        .day-card { border-left: 4px solid #1a73e8; background-color: #1a1a1a; }
        .checkbox-custom { appearance: none; -webkit-appearance: none; height: 1.25rem; width: 1.25rem; border-radius: 0.25rem; border: 2px solid #4a4a4a; background-color: #2a2a2a; cursor: pointer; position: relative; transition: background-color 0.2s, border-color 0.2s; }
        .checkbox-custom:checked { background-color: #1a73e8; border-color: #4285f4; }
        .checkbox-custom:checked::after { content: '✓'; position: absolute; color: white; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1rem; font-weight: bold; }
        .progress-bar-bg { background-color: #3a3a3a; }
        .progress-bar-fg { background-color: #1a73e8; transition: width 0.3s ease-in-out; }
        .modal { transition: opacity 0.25s ease, visibility 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        #app-loader { transition: opacity 0.3s ease-in-out; }
        .rating-emoji { transition: transform 0.2s, filter 0.2s; cursor: pointer; filter: grayscale(80%); transform: scale(1); }
        .rating-emoji.selected, .rating-emoji:hover { filter: grayscale(0%); transform: scale(1.15); }
        .rating-bar { transition: background-color 0.2s; cursor: pointer; }
        .log-entry-form { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
        .log-entry-form.open { max-height: 500px; padding-top: 1rem; padding-bottom: 1rem; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    
    <!-- App Loader -->
    <div id="app-loader" class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center">
         <svg class="animate-spin h-8 w-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
         <p id="loader-text" class="mt-4 text-lg text-gray-300">Connecting to Hub...</p>
    </div>

    <!-- Main App Content (hidden by default) -->
    <div id="main-app" class="hidden">
        <header class="bg-gray-800 shadow-lg sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
                    <div>
                        <div class="flex items-center space-x-2">
                            <svg class="w-8 h-8 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12 sutra" r="10" />
                                <path d="M8 12l2 2 4-4" />
                            </svg>
                            <h1 class="text-2xl md:text-3xl font-bold text-white">David's Recovery Hub</h1>
                        </div>
                        <p class="text-sm text-gray-400">July 21, 2025 - September 30, 2025</p>
                    </div>
                    <nav class="flex items-center space-x-6 mt-4 sm:mt-0">
                        <button data-tab="checklist" class="main-tab font-medium text-gray-300 px-1 py-2 text-base active">Daily Checklist</button>
                        <button data-tab="log" class="main-tab font-medium text-gray-300 px-1 py-2 text-base">Log</button>
                        <button data-tab="protocol" class="main-tab font-medium text-gray-300 px-1 py-2 text-base">Protocol</button>
                    </nav>
                </div>
            </div>
        </header>

        <main class="container mx-auto">
            <div id="checklist-view" class="tab-content">
                <div id="checklist-container" class="p-4 sm:p-6 lg:p-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="log-view" class="tab-content hidden">
                 <div id="log-container" class="p-4 sm:p-6 lg:p-8 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </div>

            <div id="protocol-view" class="tab-content hidden p-4 sm:p-6 lg:p-8">
                <section id="protocol" class="mb-16 scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Protocol</h2>
                    <div class="flex items-center space-x-4 text-sm text-gray-400 mb-4">
                        <div class="flex items-center"><div class="w-1 h-4 bg-emerald-500 mr-2"></div><span>Injectable</span></div>
                        <div class="flex items-center"><div class="w-1 h-4 bg-blue-500 mr-2"></div><span>Oral</span></div>
                    </div>
                    <div id="protocol-unified" class="protocol-phase-content"></div>
                </section>
                <section id="library" class="mb-16 scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Compound Library</h2>
                    <p class="mb-6 text-gray-400 max-w-3xl">Explore the science behind your recovery protocol.</p>
                    <div id="library-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </section>
                <section id="phases" class="mb-16 scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Healing Phases</h2>
                    <p class="mb-8 text-gray-400 max-w-3xl">Each stage of recovery has unique goals. Understanding them keeps expectations realistic and guides your daily focus.</p>
                    <div id="phases-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <button class="phase-card bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 text-left hover:bg-gray-700/50 transition" data-phase="inflammation">
                            <h3 class="font-bold text-blue-400 text-xl mb-2">1. Inflammation</h3>
                            <p class="text-xs text-gray-500 mb-4">Day 1 - 7</p>
                            <p class="text-gray-400 text-sm">Swelling and discomfort are highest. Protect the surgical site and start gentle mobility.</p>
                        </button>
                        <button class="phase-card bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 text-left hover:bg-gray-700/50 transition" data-phase="proliferation">
                            <h3 class="font-bold text-emerald-400 text-xl mb-2">2. Proliferation</h3>
                            <p class="text-xs text-gray-500 mb-4">Day 4 - Week 6</p>
                            <p class="text-gray-400 text-sm">Your body begins rebuilding tissue. Activity levels increase with focus on nutrition.</p>
                        </button>
                        <button class="phase-card bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 text-left hover:bg-gray-700/50 transition" data-phase="remodeling">
                            <h3 class="font-bold text-violet-400 text-xl mb-2">3. Remodeling</h3>
                            <p class="text-xs text-gray-500 mb-4">Week 4+</p>
                            <p class="text-gray-400 text-sm">Tissue strength improves as mobility returns. Gradually transition back to normal routines.</p>
                        </button>
                    </div>
                </section>
                <section id="risks" class="scroll-mt-20">
                    <h2 class="text-3xl font-bold mb-2 text-white">Risk & Safety Center</h2>
                    <p class="mb-6 text-gray-400 max-w-3xl">This section consolidates the critical risk information for your protocol compounds.</p>
                    <div class="bg-rose-900/50 border border-rose-500/30 text-rose-300 p-4 rounded-lg mb-6">
                        <h3 class="font-bold text-rose-200">⚠️ Critical Disclaimer</h3>
                        <p class="text-sm">This protocol is for informational purposes ONLY...</p>
                    </div>
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg">
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto text-left text-sm">
                                <thead class="bg-gray-700/50 text-gray-300">
                                    <tr>
                                        <th class="p-3 font-semibold">Compound</th>
                                        <th class="p-3 font-semibold">FDA Status</th>
                                        <th class="p-3 font-semibold">Primary Risks</th>
                                        <th class="p-3 font-semibold">Monitoring / Contraindications</th>
                                    </tr>
                                </thead>
                                <tbody id="risk-table" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </main>
        <div id="compound-modal" class="modal invisible opacity-0 fixed inset-0 w-full h-full bg-black/80 flex items-center justify-center p-4 z-40">
            <div id="modal-content" class="modal-content bg-gray-800 w-full max-w-2xl max-h-[90vh] rounded-lg shadow-xl border border-gray-700 transform scale-95 overflow-y-auto">
                <div class="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 id="modal-title" class="text-2xl font-bold text-white"></h3>
                    <button id="modal-close" class="text-gray-400 hover:text-white text-3xl">×</button>
                </div>
                <div class="p-6"><div id="modal-body"></div></div>
            </div>
        </div>
        <div id="uncheck-confirm-modal" class="modal invisible opacity-0 fixed inset-0 w-full h-full bg-black/80 flex items-center justify-center p-4 z-50">
            <div class="modal-content bg-gray-800 w-full max-w-md rounded-lg shadow-xl border border-gray-700 transform scale-95 p-6 text-center">
                <h3 class="text-xl font-bold text-white mb-4">Confirm Action</h3>
                <p class="text-gray-300 mb-6">Are you sure you want to mark this item as incomplete? This action will be synced for all users.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-uncheck" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancel</button>
                    <button id="confirm-uncheck" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyBvOuLfBr1-faAK7RC5QkgD6hxhD9oWaP0",
                authDomain: "post-surgery-recovery-plan.firebaseapp.com",
                projectId: "post-surgery-recovery-plan",
                storageBucket: "post-surgery-recovery-plan.firebasestorage.app",
                messagingSenderId: "640490803020",
                appId: "1:640490803020:web:07a9a0322792daff0d89e9",
                measurementId: "G-R4BG49JC7N"
            };

            const appData = {
                checklist: { 
                    startDate: '2025-07-21', 
                    endDate: '2025-09-30', 
                    items: { 
                        "bpc-157": { key: "bpc-157", name: "BPC-157", dose: "400mcg", inj: "12 IU", time: "AM", freq: "daily" }, 
                        "bpc-157-pm": { key: "bpc-157", name: "BPC-157", dose: "400mcg", inj: "12 IU", time: "PM", freq: "daily" }, 
                        "tb-500": { key: "tb-500", name: "TB-500", dose: "1mg", inj: "60 IU", time: "Any", freq: "daily" }, 
                        "kpv": { key: "kpv", name: "KPV", dose: "400mcg", inj: "12 IU", time: "AM", freq: "daily" }, 
                        "kpv-pm": { key: "kpv", name: "KPV", dose: "400mcg", inj: "12 IU", time: "PM", freq: "daily" }, 
                        "collagen": { key: "collagen", name: "Collagen", dose: "15g", time: "AM", freq: "daily" }, 
                        "collagen-pm": { key: "collagen", name: "Collagen", dose: "15g", time: "PM", freq: "daily" }, 
                        "vit-c": { key: "vit-c", name: "Vit C", dose: "1g", time: "AM Meal", freq: "daily" }, 
                        "vit-c-pm": { key: "vit-c", name: "Vit C", dose: "1g", time: "PM Meal", freq: "daily" }, 
                        "vit-d": { key: "vit-d", name: "Vit D", dose: "5,000 IU", time: "With Meal", freq: "daily" }, 
                        "ha-oral": { key: "ha", name: "Hyaluronic Acid", dose: "200mg", time: "Any", freq: "daily" }, 
                        "ghk-cu": { key: "ghk-cu", name: "GHK-Cu", dose: "1mg", inj: "4 IU", time: "PM", freq: "daily" }, 
                        "hgh": { key: "hgh", name: "HGH", dose: "1.5 IU", inj: "11 IU", time: "AM", freq: "daily" }, 
                        "hgh-pm": { key: "hgh", name: "HGH", dose: "1.5 IU", inj: "11 IU", time: "PM", freq: "daily" }, 
                        "rlt": { key: "rlt", name: "Red Light", dose: "10-15 min", time: "Any", freq: "eod" }, 
                        "retatrutide-p3": { key: "retatrutide", name: "Retatrutide", dose: "4mg", inj: "120 IU (split)", time: "Any", freq: "weekly" } 
                    } 
                },
                protocol: { 
                    "bpc-157": { 
                        name: "BPC-157", 
                        category: "Peptide", 
                        status: "research", 
                        info: { 
                            summary: "BPC-157, or Body Protection Compound-157, is a synthetic peptide consisting of 15 amino acids, derived from a protein found in human gastric juice known as Body Protection Compound (BPC). Discovered in the 1990s during research into gastric proteins, it was initially explored for its potential to treat ulcers and gastrointestinal disorders. However, its remarkable regenerative properties soon became evident, leading to extensive studies on its ability to accelerate healing across various tissues, including skin, muscle, tendons, ligaments, and the gut. BPC-157 promotes the formation of new blood vessels (angiogenesis), enhances collagen production, and exhibits potent anti-inflammatory effects, making it a promising tool for post-surgical recovery. Its localized action allows it to target specific injury sites effectively, while its systemic benefits support overall tissue health. Although not yet approved by the FDA, its safety profile in animal studies is encouraging, with ongoing research aimed at unlocking its full therapeutic potential.", 
                            mechanism: "BPC-157 primarily works by promoting angiogenesis, the process of forming new blood vessels, which enhances the delivery of oxygen and nutrients to damaged tissues. It stimulates the migration and proliferation of fibroblasts, the cells responsible for synthesizing collagen, a critical component of tissue repair. Additionally, it upregulates growth hormone receptors, potentially amplifying the effects of human growth hormone (HGH) when used concurrently. BPC-157 modulates inflammatory pathways by reducing pro-inflammatory cytokines and increasing anti-inflammatory mediators, creating an optimal healing environment. It also activates the FAK-paxillin signaling pathway, essential for cell migration and adhesion, and influences the expression of vascular endothelial growth factor (VEGF) to further support angiogenesis. Emerging research suggests neuroprotective effects, indicating potential benefits for nerve repair post-surgery.", 
                            notes: "Subcutaneous injection near (but not into) surgical incisions is the most effective method for localized tissue healing, delivering BPC-157 directly to the site of injury. Its synergy with HGH may enhance overall regenerative outcomes. Sourcing from reputable suppliers is critical due to its unregulated status, ensuring purity and minimizing contamination risks. While animal studies report no significant toxicity, its long-term effects in humans remain unknown, necessitating caution and professional oversight. BPC-157 may also support gastrointestinal health and reduce scar formation, making it a versatile component of recovery protocols." 
                        }, 
                        risk: { status: "Unapproved drug; not for human use.", primary: "Lack of long-term human safety data; significant sourcing risks (purity, contaminants). Reported side effects are generally mild: nausea, fatigue, dizziness.", monitoring: "Unknown long-term effects." } 
                    }, 
                    "tb-500": { 
                        name: "TB-500", 
                        category: "Peptide", 
                        status: "research", 
                        info: { 
                            summary: "TB-500 is a synthetic version of Thymosin Beta-4 (Tβ4), a 43-amino-acid peptide naturally present in high concentrations in blood platelets, wound fluid, and various tissues. It plays a pivotal role in systemic healing by regulating actin, a fundamental protein in cell structure and movement. Extensively studied in animal models, TB-500 accelerates recovery from injuries to skin, muscle, tendons, and ligaments by promoting angiogenesis, reducing inflammation, and enhancing stem cell migration. Its systemic effects make it ideal for whole-body repair, particularly in post-surgical contexts where widespread tissue damage occurs. While not FDA-approved, its use in athletic and regenerative communities highlights its potential, though human clinical data remains limited.", 
                            mechanism: "TB-500 upregulates actin, facilitating cell migration, differentiation, and proliferation across the body. It acts as a systemic signal, attracting repair cells to injury sites and promoting angiogenesis to improve blood flow. Its anti-inflammatory properties reduce swelling and pain, while its ability to enhance stem cell activity accelerates tissue regeneration. TB-500 also boosts mitochondrial function, increasing cellular energy for healing processes.", 
                            notes: "Administered subcutaneously, a daily dose ensures steady systemic support. Often paired with BPC-157 for synergistic effects, TB-500’s broad action complements localized therapies. Its experimental nature requires careful sourcing and monitoring." 
                        }, 
                        risk: { status: "Unapproved drug; not for human use.", primary: "Lack of long-term human safety data. Its potent angiogenic properties mean it could theoretically promote tumor growth.", monitoring: "Contraindicated in individuals with a history of or active cancer." } 
                    }, 
                    "ghk-cu": { 
                        name: "GHK-Cu", 
                        category: "Peptide", 
                        status: "research", 
                        info: { 
                            summary: "GHK-Cu is a copper-binding tripeptide naturally occurring in human plasma, known for its role in dermal remodeling and tissue regeneration. First identified in the 1970s, it declines with age, correlating with reduced healing capacity. The injectable form delivers systemic benefits, supporting skin health, wound healing, and anti-aging by stimulating collagen and elastin production while clearing damaged proteins. Research also explores its potential in hair growth and neuroprotection, making it a multifaceted recovery tool.", 
                            mechanism: "GHK-Cu regulates extracellular matrix (ECM) turnover, promoting healthy collagen and elastin synthesis while removing disorganized scar tissue. It modulates gene expression to favor regeneration, enhances antioxidant defenses, and supports angiogenesis, improving tissue oxygenation.", 
                            notes: "Systemic administration via injection maximizes its widespread effects. Its copper content requires monitoring to avoid excess, particularly in those with copper metabolism issues." 
                        }, 
                        risk: { status: "Unapproved drug; not for human use.", primary: "Lack of human safety data. Potential for injection site reactions, flushing, or nausea. Systemic copper administration carries risks.", monitoring: "Contraindicated in individuals with copper metabolism disorders (e.g., Wilson's disease)." } 
                    }, 
                    "kpv": { 
                        name: "KPV", 
                        category: "Peptide", 
                        status: "research", 
                        info: { 
                            summary: "KPV, a tripeptide derived from alpha-melanocyte-stimulating hormone (α-MSH), is renowned for its potent anti-inflammatory properties. It excels at controlling post-surgical inflammation, reducing pain and swelling without suppressing the necessary immune response. Its antimicrobial effects further protect healing tissues, making it a key player in early recovery phases.", 
                            mechanism: "KPV inhibits inflammatory pathways like NF-κB, reducing pro-inflammatory cytokine production while promoting resolution. It also disrupts microbial growth, enhancing tissue safety.", 
                            notes: "Subcutaneous injections provide systemic anti-inflammatory benefits. Ideal for acute inflammation management, KPV’s mild side effect profile supports its experimental use." 
                        }, 
                        risk: { status: "Unapproved peptide; not for human use.", primary: "Lack of human safety data. Reported side effects are typically mild, such as minor GI or skin reactions.", monitoring: "Unknown long-term effects." } 
                    }, 
                    "hgh": { 
                        name: "HGH", 
                        category: "Hormone", 
                        status: "prescription", 
                        info: { 
                            summary: "Human Growth Hormone (HGH), or somatropin, is a pituitary-derived hormone driving regeneration, growth, and metabolism. Its synthetic form enhances post-surgical healing by boosting collagen synthesis and cell repair across the body. Widely used in regenerative medicine, HGH requires careful dosing due to its potency.", 
                            mechanism: "HGH stimulates IGF-1 production, promoting cell proliferation and collagen formation. It enhances protein synthesis and fat metabolism, fueling tissue repair.", 
                            notes: "AM/PM split dosing stabilizes levels and minimizes side effects. Prescription-only status mandates medical supervision." 
                        }, 
                        risk: { status: "Prescription drug. Off-label distribution is illegal.", primary: "Edema, arthralgia, carpal tunnel syndrome, impaired glucose tolerance.", monitoring: "Contraindicated in acute critical illness post-surgery and in active cancer." } 
                    }, 
                    "retatrutide": { 
                        name: "Retatrutide", 
                        category: "Peptide", 
                        status: "experimental", 
                        info: { 
                            summary: "Retatrutide is an experimental triple-receptor agonist (GLP-1, GIP, glucagon) designed for metabolic optimization and inflammation control. Under investigation for obesity and metabolic disorders, it supports healing by improving energy allocation and reducing systemic inflammation.", 
                            mechanism: "It enhances insulin sensitivity, lipid profiles, and blood pressure, directing energy to repair while lowering inflammation via multi-receptor action.", 
                            notes: "Highly experimental; its 4mg dose requires split injections. Use is speculative, based on emerging research." 
                        }, 
                        risk: { status: "Investigational new drug (in clinical trials).", primary: "Nausea, GI issues; long-term safety unknown.", monitoring: "Not legally available outside clinical trials." } 
                    }, 
                    "collagen": { 
                        name: "Collagen", 
                        category: "Supplement", 
                        status: "supplement", 
                        info: { 
                            summary: "Collagen, the body’s most abundant protein, provides essential amino acids (glycine, proline) for skin, joint, and bone repair. Hydrolyzed collagen supplements enhance wound healing, elasticity, and hydration, supporting post-surgical recovery.", 
                            mechanism: "Supplies building blocks for Type I and III collagen, stimulating endogenous production and strengthening the dermal matrix.", 
                            notes: "Split 30g daily dose improves absorption. Hydrolyzed form ensures bioavailability." 
                        }, 
                        risk: { status: "Supplement (GRAS)", primary: "Generally very low risk.", monitoring: "Follow recommended dosage." } 
                    }, 
                    "vit-c": { 
                        name: "Vit C", 
                        category: "Supplement", 
                        status: "supplement", 
                        info: { 
                            summary: "Vitamin C is an essential cofactor for collagen synthesis and a powerful antioxidant, critical for tissue repair and immune support post-surgery.", 
                            mechanism: "Facilitates collagen cross-linking by enzymes and neutralizes oxidative stress, protecting healing tissues.", 
                            notes: "High doses in divided increments maintain levels during recovery." 
                        }, 
                        risk: { status: "Supplement (GRAS)", primary: "Low risk; high doses may cause GI upset.", monitoring: "Follow recommended dosage." } 
                    }, 
                    "vit-d": { 
                        name: "Vit D", 
                        category: "Supplement", 
                        status: "supplement", 
                        info: { 
                            summary: "Vitamin D modulates immune function and cellular differentiation, vital for healing and infection prevention. Synthesized via sunlight or supplemented, it supports bone and tissue health.", 
                            mechanism: "Regulates cell proliferation and enhances calcium absorption, reducing recovery complications.", 
                            notes: "Dosage should correct pre-existing deficiencies, guided by blood tests." 
                        }, 
                        risk: { status: "Supplement (GRAS)", primary: "Low risk at recommended doses; toxicity rare.", monitoring: "Follow recommended dosage." } 
                    }, 
                    "ha": { 
                        name: "Hyaluronic Acid", 
                        category: "Supplement", 
                        status: "supplement", 
                        info: { 
                            summary: "Hyaluronic Acid, a key skin matrix component, hydrates and supports tissue repair across all healing phases.", 
                            mechanism: "Facilitates cell migration and reduces inflammation, enhancing structural integrity.", 
                            notes: "Oral and topical use improves hydration and elasticity." 
                        }, 
                        risk: { status: "Supplement (GRAS)", primary: "Generally very low risk.", monitoring: "Follow recommended dosage." } 
                    }, 
                    "rlt": { 
                        name: "Red Light", 
                        category: "Therapy", 
                        status: "device", 
                        info: { 
                            summary: "Red Light Therapy uses specific light wavelengths (630-850nm) to boost cellular energy and healing non-invasively, aiding skin repair and inflammation reduction.", 
                            mechanism: "Photons enhance mitochondrial ATP production, accelerating collagen synthesis, angiogenesis, and blood flow.", 
                            notes: "Requires red and near-infrared devices; safe and effective as an adjunct therapy." 
                        }, 
                        risk: { status: "FDA-cleared devices exist", primary: "Low risk; potential skin/eye irritation.", monitoring: "Use eye protection." } 
                    } 
                }
            };

            const unifiedItems = ['bpc-157', 'bpc-157-pm', 'tb-500', 'kpv', 'kpv-pm', 'collagen', 'collagen-pm', 'vit-c', 'vit-c-pm', 'vit-d', 'ha-oral', 'ghk-cu', 'hgh', 'hgh-pm', 'rlt', 'retatrutide-p3'];
            const injectableKeys = new Set(['bpc-157', 'tb-500', 'kpv', 'ghk-cu', 'hgh']);

            const phaseDetails = {
                inflammation: {
                    title: 'Phase I: Inflammation',
                    body: `<p class="mb-4">Immediately after surgery your body enters a protective inflammatory response. Swelling, warmth and soreness are signs that immune cells are rushing in to defend the area and begin repairing damaged tissue. Rest, ice and elevation are key during this time to keep discomfort manageable while still allowing blood flow.</p>
                           <p class="mb-4">Short bouts of gentle movement help circulate lymph and prevent stiffness, but you should avoid pushing into pain. Supportive garments or wraps can reduce excessive fluid build-up around the incision. Maintain any medication schedule prescribed by your doctor and pay attention to early warning signs of infection such as fever or unusual redness.</p>
                           <p class="mb-4">Good sleep and adequate hydration give your body the building blocks it needs to start knitting tissue back together. Most people will notice swelling peak around day three and then slowly begin to subside. Patience is essential—trying to speed this stage often leads to setbacks.</p>`
                },
                proliferation: {
                    title: 'Phase II: Proliferation',
                    body: `<p class="mb-4">Within a week new cells and collagen fibers actively rebuild the surgical site. Light activity like short walks or stretching increases nutrient delivery and encourages proper alignment of the developing tissue. Pain typically decreases, though fatigue may linger as your body uses a great deal of energy to regenerate.</p>
                           <p class="mb-4">A nutrient-dense diet becomes especially important. Lean proteins, colorful vegetables and adequate water support the creation of fresh connective tissue. Your care team may introduce targeted physical therapy or massage to minimize scar tissue and encourage a healthy range of motion.</p>
                           <p class="mb-4">Listen closely to your body and scale activities accordingly. While many people feel better during this stage, overexertion can easily inflame healing tissues. Consistency and moderate effort provide far better results than sporadic bursts of high intensity.</p>`
                },
                remodeling: {
                    title: 'Phase III: Remodeling',
                    body: `<p class="mb-4">Several weeks in, the focus shifts from creating new tissue to strengthening it. Collagen fibers reorganize along lines of tension, gradually improving durability. You can begin reintroducing more demanding movements, but continue to respect any lingering soreness or tightness.</p>
                           <p class="mb-4">Functional exercises and daily activities help your body adapt to the stresses of normal life. Keep monitoring the incision for signs of irritation and consider gentle scar massage or silicone treatments if recommended by your provider.</p>
                           <p class="mb-4">Long-term recovery hinges on maintaining good habits established earlier: quality sleep, balanced nutrition and progressive movement. Even when you feel nearly back to normal, underlying tissues continue maturing for months. Staying consistent during this phase sets the stage for a full and lasting return to your usual routine.</p>`
                }
            };

            let db;
            let checklistDocRef;
            let logsDocRef;
            let unsubscribeChecklist;
            let unsubscribeLogs;
            let checkboxToUncheck = null;
            
            const mainApp = document.getElementById('main-app');
            const appLoader = document.getElementById('app-loader');
            const loaderText = document.getElementById('loader-text');
            const modal = document.getElementById('compound-modal');
            const uncheckModal = document.getElementById('uncheck-confirm-modal');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalClose = document.getElementById('modal-close');
            const confirmUncheckBtn = document.getElementById('confirm-uncheck');
            const cancelUncheckBtn = document.getElementById('cancel-uncheck');

            function runApp() {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    appLoader.classList.remove('hidden');
                    loaderText.textContent = "Firebase config missing in HTML file.";
                    return;
                }
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                db = getFirestore(app);
                checklistDocRef = doc(db, "recoveryState", "checklist");
                logsDocRef = doc(db, "recoveryState", "logs");

                startApp();
            }

            async function startApp() {
                appLoader.classList.remove('hidden');
                initializeProtocolView();
                initializeChecklist();
                initializeLogView();
                handleTabSwitching();
                setupUncheckModalListeners();
                
                unsubscribeChecklist = onSnapshot(checklistDocRef, (docSnap) => {
                    const remoteData = docSnap.exists() ? docSnap.data() : {};
                    updateCheckboxesFromRemote(remoteData);
                });
                
                unsubscribeLogs = onSnapshot(logsDocRef, (docSnap) => {
                    const remoteData = docSnap.exists() ? docSnap.data() : {};
                    updateLogsFromRemote(remoteData);
                });

                appLoader.classList.add('opacity-0', 'pointer-events-none');
                mainApp.classList.remove('hidden');
            }
            
            function updateCheckboxStateInFirestore(id, data) {
                 const updateData = { [id]: data };
                 setDoc(checklistDocRef, updateData, { merge: true });
            }
            
            function updateCheckboxesFromRemote(remoteData) {
                document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(checkbox => {
                    const checkboxData = remoteData[checkbox.id];
                    const shouldBeChecked = checkboxData && checkboxData.checked === true;
                    
                    if (checkbox.checked !== shouldBeChecked) {
                        checkbox.checked = shouldBeChecked;
                    }

                    const timestampEl = document.getElementById(`ts-${checkbox.id}`);
                    if (shouldBeChecked && checkboxData.ts) {
                        timestampEl.textContent = `Completed: ${checkboxData.ts}`;
                        timestampEl.classList.remove('hidden');
                    } else {
                        timestampEl.textContent = '';
                        timestampEl.classList.add('hidden');
                    }

                    const dayCard = checkbox.closest('.day-card');
                    if(dayCard) updateDayProgress(dayCard);
                });
            }

            function updateDayProgress(dayCard) {
                const checkboxes = dayCard.querySelectorAll('input[type="checkbox"]');
                const progressBar = dayCard.querySelector('.progress-bar-fg');
                if (!progressBar) return;
                const totalCheckboxes = checkboxes.length;
                const checkedCount = dayCard.querySelectorAll('input[type="checkbox"]:checked').length;
                const progressPercentage = totalCheckboxes > 0 ? (checkedCount / totalCheckboxes) * 100 : 0;
                progressBar.style.width = `${progressPercentage}%`;
            }

            function handleCheckboxChange(e) {
                const checkbox = e.target;
                if (checkbox.checked) {
                    const timestamp = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    updateCheckboxStateInFirestore(checkbox.id, { checked: true, ts: timestamp });
                    const dayCard = checkbox.closest('.day-card');
                    if(dayCard) updateDayProgress(dayCard);
                } else {
                    checkboxToUncheck = checkbox;
                    checkbox.checked = true;
                    uncheckModal.classList.remove('invisible', 'opacity-0');
                }
            }
            
            function setupUncheckModalListeners() {
                function closeUncheckModal() {
                    uncheckModal.classList.add('invisible', 'opacity-0');
                    checkboxToUncheck = null;
                }
                
                cancelUncheckBtn.addEventListener('click', closeUncheckModal);
                uncheckModal.addEventListener('click', (e) => {
                    if (e.target === uncheckModal) closeUncheckModal();
                });

                confirmUncheckBtn.addEventListener('click', () => {
                    if (checkboxToUncheck) {
                        checkboxToUncheck.checked = false;
                        updateCheckboxStateInFirestore(checkboxToUncheck.id, { checked: false, ts: null });
                        const dayCard = checkboxToUncheck.closest('.day-card');
                        if(dayCard) updateDayProgress(dayCard);
                    }
                    closeUncheckModal();
                });
            }

            function initializeChecklist() {
                const checklistContainer = document.getElementById('checklist-container');
                checklistContainer.innerHTML = '';
                const { startDate: start, endDate: end, items } = appData.checklist;
                const startDate = new Date(start + 'T00:00:00');
                const endDate = new Date(end + 'T00:00:00');
                let currentDate = new Date(startDate);
                let dayCounter = 0;
                let dayOfWeekCounter = currentDate.getDay();

                const timeSortOrder = { 'AM': 1, 'AM Meal': 1, 'Any': 2, 'With Meal': 2, 'Evening': 3, 'PM': 3, 'PM Meal': 3 };

                while (currentDate <= endDate) {
                    const dayIndex = dayCounter;
                    const dayCard = document.createElement('div');
                    dayCard.className = `day-card bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col`;
                    dayCard.id = `day-${dayIndex}`;
                    const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    
                    let itemsForDay = [];
                    for (const key in items) {
                        if (unifiedItems.includes(key)) {
                            const item = items[key];
                            let shouldAdd = false;
                            if (item.freq === 'daily' || (item.freq === 'eod' && dayIndex % 2 === 0)) {
                                shouldAdd = true;
                            } else if (item.freq === 'weekly' && dayOfWeekCounter % 7 === 0) {
                                shouldAdd = true;
                            }
                            if (shouldAdd) itemsForDay.push({ ...item, checklistKey: key });
                        }
                    }

                    itemsForDay.sort((a, b) => (timeSortOrder[a.time] || 99) - (timeSortOrder[b.time] || 99));

                    let checklistHTML = itemsForDay.map(item => {
                        const id = `check-${dayIndex}-${item.checklistKey}`;
                        const injText = item.inj ? `<span class="font-mono text-xs text-blue-400">${item.inj}</span>` : '';
                        return `<div class="flex items-center justify-between py-2 border-b border-gray-700 last:border-b-0">
                                <label class="flex items-start cursor-pointer flex-grow mr-2">
                                    <input type="checkbox" id="${id}" class="checkbox-custom mr-3 flex-shrink-0 mt-1">
                                    <div class="min-w-0">
                                        <span class="font-medium text-gray-200">${item.name}</span>
                                        <span class="text-sm text-gray-400 ml-2">${item.dose}</span>
                                        <div id="ts-${id}" class="text-xs text-blue-400 mt-1 hidden"></div>
                                    </div>
                                </label>
                                ${injText}<span class="text-sm text-gray-500 ml-auto pl-2 text-right self-start mt-1">${item.time}</span></div>`;
                    }).join('');

                    dayCard.innerHTML = `<h3 class="font-bold text-lg text-white mb-2">${dateString}</h3><div class="flex-grow">${checklistHTML || '<p class="text-gray-500 text-sm py-2">Rest day from scheduled therapies.</p>'}</div>
                        <div class="mt-4"><div class="progress-bar-bg w-full h-2 rounded-full overflow-hidden"><div class="progress-bar-fg h-full" style="width: 0%;"></div></div></div>`;
                    checklistContainer.appendChild(dayCard);
                    
                    dayCard.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', handleCheckboxChange);
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                    dayCounter++;
                    dayOfWeekCounter++;
                }
            }
            
            function initializeProtocolView() {
                 populateProtocolTables(); 
                 populateLibrary(); 
                 populateRiskTable(); 
                 setupProtocolEventListeners();
            }

            function populateProtocolTables() {
                const unifiedContainer = document.getElementById('protocol-unified');
                let tableRowsHTML = '';
                unifiedItems.forEach(key => {
                    const item = appData.checklist.items[key];
                    const compound = appData.protocol[item.key];
                    const injectable = injectableKeys.has(item.key);
                    const lineClass = injectable ? 'bg-emerald-500' : 'bg-blue-500';
                    tableRowsHTML += `<tr class="hover:bg-gray-700/50"><td class="p-3 font-medium"><span class="inline-block w-1 h-4 ${lineClass} mr-2"></span><button data-key="${item.key}" class="compound-link text-blue-400 hover:text-blue-300 hover:underline">${compound.name}</button></td><td class="p-3 text-gray-300">${item.dose}</td><td class="p-3 text-gray-300">${item.freq}</td><td class="p-3 text-gray-300">${item.time}</td><td class="p-3 text-gray-300 font-mono">${item.inj || '—'}</td></tr>`;
                });
                unifiedContainer.innerHTML = `<div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg"><div class="overflow-x-auto"><table class="w-full table-auto text-left text-sm"><thead class="bg-gray-700/50 text-gray-300"><tr><th class="p-3 font-semibold">Compound</th><th class="p-3 font-semibold">Dosage</th><th class="p-3 font-semibold">Frequency</th><th class="p-3 font-semibold">Time of Day</th><th class="p-3 font-semibold">Inj. Amount (units)</th></tr></thead><tbody class="divide-y divide-gray-700">${tableRowsHTML}</tbody></table></div></div>`;
            }

            function populateLibrary() {
                const libraryGrid = document.getElementById('library-grid'); 
                libraryGrid.innerHTML = '';
                for (const key in appData.protocol) { 
                    const compound = appData.protocol[key]; 
                    const statusStyles = { 
                        research: { icon: '🔬', bg: 'bg-blue-500/20', text: 'text-blue-300' }, 
                        experimental: { icon: '🧪', bg: 'bg-purple-500/20', text: 'text-purple-300' }, 
                        prescription: { icon: '💊', bg: 'bg-green-500/20', text: 'text-green-300' }, 
                        'prescription-c': { icon: '⚠️', bg: 'bg-red-500/20', text: 'text-red-300' }, 
                        supplement: { icon: '🌿', bg: 'bg-emerald-500/20', text: 'text-emerald-300' }, 
                        device: { icon: '💡', bg: 'bg-gray-500/20', text: 'text-gray-300' } 
                    }; 
                    const style = statusStyles[compound.status] || statusStyles['device'];
                    const card = `<button data-key="${key}" class="compound-link text-left w-full h-full bg-gray-800 p-4 rounded-lg shadow-lg hover:shadow-xl hover:bg-gray-700/50 transition-all duration-200 flex flex-col justify-between border border-gray-700"><div><h4 class="font-bold text-white">${compound.name}</h4><p class="text-xs text-gray-400 mb-2">${compound.category}</p><p class="text-sm text-gray-300">${compound.info.summary}</p></div><div class="mt-3"><span class="text-xs font-semibold px-2 py-1 rounded-full ${style.bg} ${style.text}">${style.icon} ${compound.status.replace('-c', ' (Controlled)')}</span></div></button>`; 
                    libraryGrid.innerHTML += card; 
                }
            }

            function populateRiskTable() {
                const riskTableBody = document.getElementById('risk-table'); 
                riskTableBody.innerHTML = '';
                for (const key in appData.protocol) { 
                    const compound = appData.protocol[key]; 
                    if (!compound.risk) continue; 
                    let nameCellClass = "text-gray-200"; 
                    if(compound.status === 'prescription-c') nameCellClass = "text-red-400 font-bold"; 
                    if(compound.status === 'research' || compound.status === 'experimental') nameCellClass = "text-blue-400 font-semibold";
                    const row = `<tr class="hover:bg-gray-700/50"><td class="p-3 font-medium ${nameCellClass}">${compound.name}</td><td class="p-3 text-gray-300">${compound.risk.status}</td><td class="p-3 text-gray-300">${compound.risk.primary}</td><td class="p-3 text-gray-300">${compound.risk.monitoring}</td></tr>`; 
                    riskTableBody.innerHTML += row; 
                }
            }

            function openModal(key) {
                const compound = appData.protocol[key]; 
                modalTitle.textContent = compound.name; 
                let notesHtml = compound.info.notes ? `<div class="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-md"><h5 class="font-semibold text-blue-300">Key Notes</h5><p class="text-sm text-blue-300/80">${compound.info.notes}</p></div>` : '';
                modalBody.innerHTML = `<p class="text-gray-300 mb-4">${compound.info.summary}</p><h4 class="font-bold text-lg text-white mb-2">Mechanism of Action</h4><p class="text-gray-300">${compound.info.mechanism}</p>${notesHtml}`; 
                modal.classList.remove('invisible', 'opacity-0'); 
                modalContent.classList.remove('scale-95');
            }

            function openPhaseModal(key) {
                const phase = phaseDetails[key];
                modalTitle.textContent = phase.title;
                modalBody.innerHTML = phase.body;
                modal.classList.remove('invisible', 'opacity-0');
                modalContent.classList.remove('scale-95');
            }

            function closeModal() { 
                modal.classList.add('invisible', 'opacity-0'); 
                modalContent.classList.add('scale-95'); 
            }

            function setupProtocolEventListeners() {
                document.querySelectorAll('#protocol-view .compound-link').forEach(link => { 
                    link.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        openModal(link.dataset.key); 
                    }); 
                });
                document.querySelectorAll('.phase-card').forEach(card => {
                    card.addEventListener('click', () => openPhaseModal(card.dataset.phase));
                });
            }

            function handleTabSwitching() {
                document.querySelectorAll('.main-tab').forEach(tab => { 
                    tab.addEventListener('click', () => { 
                        document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active')); 
                        tab.classList.add('active'); 
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden')); 
                        document.getElementById(`${tab.dataset.tab}-view`).classList.remove('hidden'); 
                    }); 
                });
            }
            
            function initializeLogView() {
                const logContainer = document.getElementById('log-container');
                logContainer.innerHTML = '';
                const { startDate: start, endDate: end } = appData.checklist;
                const startDate = new Date(start + 'T00:00:00');
                const endDate = new Date(end + 'T00:00:00');
                let currentDate = new Date(startDate);
                let dayCounter = 0;

                while(currentDate <= endDate) {
                    const dayIndex = `day-${dayCounter}`;
                    const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    
                    const logCard = document.createElement('div');
                    logCard.className = 'bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col space-y-4';
                    logCard.id = `log-${dayIndex}`;
                    logCard.innerHTML = `
                        <div>
                            <h3 class="font-bold text-lg text-white">${dateString}</h3>
                            <div id="log-display-${dayIndex}" class="mt-2 text-sm text-gray-400">No entry for this day.</div>
                        </div>
                        <div id="log-form-${dayIndex}" class="log-entry-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-semibold text-gray-300 text-sm">Overall Feeling:</label>
                                    <div data-metric="feeling" class="flex justify-around items-center text-2xl mt-2">
                                        <span data-value="1" class="rating-emoji">😞</span>
                                        <span data-value="2" class="rating-emoji">😐</span>
                                        <span data-value="3" class="rating-emoji">🙂</span>
                                        <span data-value="4" class="rating-emoji">😊</span>
                                        <span data-value="5" class="rating-emoji">😁</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-300 text-sm">Swelling / Inflammation:</label>
                                    <div data-metric="swelling" class="flex justify-between items-center mt-2 space-x-1">
                                        <div data-value="1" class="rating-bar flex-1 h-3 bg-gray-600 rounded-l-lg"></div>
                                        <div data-value="2" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="3" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="4" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="5" class="rating-bar flex-1 h-3 bg-gray-600 rounded-r-lg"></div>
                                    </div>
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-300 text-sm">Scar Appearance:</label>
                                    <div data-metric="scar" class="flex justify-between items-center mt-2 space-x-1">
                                        <div data-value="1" class="rating-bar flex-1 h-3 bg-gray-600 rounded-l-lg"></div>
                                        <div data-value="2" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="3" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="4" class="rating-bar flex-1 h-3 bg-gray-600"></div>
                                        <div data-value="5" class="rating-bar flex-1 h-3 bg-gray-600 rounded-r-lg"></div>
                                    </div>
                                </div>
                                <div>
                                    <label for="notes-${dayIndex}" class="font-semibold text-gray-300 text-sm">Notes:</label>
                                    <textarea id="notes-${dayIndex}" class="w-full bg-gray-700 text-gray-200 rounded-md p-2 mt-2 h-24 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <button data-dayindex="${dayIndex}" class="save-log-btn w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Log</button>
                            </div>
                        </div>
                        <button data-dayindex="${dayIndex}" class="toggle-log-form-btn mt-auto text-sm text-blue-400 hover:text-blue-300 self-start">Add / Edit Log</button>
                    `;
                    logContainer.appendChild(logCard);
                    currentDate.setDate(currentDate.getDate() + 1);
                    dayCounter++;
                }
                setupLogEventListeners();
            }

            function setupLogEventListeners() {
                document.querySelectorAll('.toggle-log-form-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const form = document.getElementById(`log-form-${btn.dataset.dayindex}`);
                        form.classList.toggle('open');
                        btn.textContent = form.classList.contains('open') ? 'Close' : 'Add / Edit Log';
                    });
                });

                document.querySelectorAll('.rating-emoji').forEach(emoji => {
                    emoji.addEventListener('click', () => {
                        const parent = emoji.parentElement;
                        parent.querySelectorAll('.rating-emoji').forEach(e => e.classList.remove('selected'));
                        emoji.classList.add('selected');
                        parent.dataset.rating = emoji.dataset.value;
                    });
                });

                document.querySelectorAll('[data-metric] .rating-bar').forEach(bar => {
                    bar.addEventListener('click', () => {
                        const parent = bar.parentElement;
                        const value = bar.dataset.value;
                        const bars = parent.querySelectorAll('.rating-bar');
                        const colors = ['bg-green-500', 'bg-yellow-500', 'bg-orange-500', 'bg-red-500', 'bg-red-700'];
                        
                        bars.forEach((b, i) => {
                            if (i < value) {
                                b.className = `rating-bar flex-1 h-3 ${colors[i]} transition-colors`;
                            } else {
                                b.className = 'rating-bar flex-1 h-3 bg-gray-600 transition-colors';
                            }
                        });
                        bars[0].classList.add('rounded-l-lg');
                        bars[bars.length - 1].classList.add('rounded-r-lg');

                        parent.dataset.rating = value;
                    });
                });

                document.querySelectorAll('.save-log-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const dayIndex = btn.dataset.dayindex;
                        const form = document.getElementById(`log-form-${dayIndex}`);
                        const logData = {
                            feeling: form.querySelector('[data-metric="feeling"]').dataset.rating || null,
                            swelling: form.querySelector('[data-metric="swelling"]').dataset.rating || null,
                            scar: form.querySelector('[data-metric="scar"]').dataset.rating || null,
                            notes: form.querySelector(`#notes-${dayIndex}`).value,
                            timestamp: new Date().toISOString()
                        };
                        updateLogStateInFirestore(dayIndex, logData);
                        form.classList.remove('open');
                        document.querySelector(`.toggle-log-form-btn[data-dayindex="${dayIndex}"]`).textContent = 'Add / Edit Log';
                    });
                });
            }

            function updateLogStateInFirestore(dayIndex, data) {
                 const updateData = { [dayIndex]: data };
                 setDoc(logsDocRef, updateData, { merge: true });
            }

            function updateLogsFromRemote(remoteData) {
                const ratingColors = { '1': 'bg-green-500', '2': 'bg-yellow-500', '3': 'bg-orange-500', '4': 'bg-red-500', '5': 'bg-red-700' };
                const feelingEmojis = { '1': '😞', '2': '😐', '3': '🙂', '4': '😊', '5': '😁' };
                const ratingLabels = { '1': 'Very Low', '2': 'Low', '3': 'Moderate', '4': 'High', '5': 'Very High' };

                for (const dayIndex in remoteData) {
                    const logData = remoteData[dayIndex];
                    const displayEl = document.getElementById(`log-display-${dayIndex}`);
                    const formEl = document.getElementById(`log-form-${dayIndex}`);

                    if (displayEl) {
                        if (logData && logData.timestamp) {
                            let displayHTML = '<ul class="space-y-1">';
                            if (logData.feeling) displayHTML += `<li>Feeling: <span class="text-xl">${feelingEmojis[logData.feeling]}</span></li>`;
                            if (logData.swelling) displayHTML += `<li>Swelling: <span class="font-semibold text-gray-200">${ratingLabels[logData.swelling]}</span></li>`;
                            if (logData.scar) displayHTML += `<li>Scar Appearance: <span class="font-semibold text-gray-200">${ratingLabels[logData.scar]}</span></li>`;
                            if (logData.notes) displayHTML += `<li>Notes: <p class="whitespace-pre-wrap italic text-gray-400">${logData.notes}</p></li>`;
                            displayHTML += '</ul>';
                            displayEl.innerHTML = displayHTML;
                        } else {
                            displayEl.innerHTML = 'No entry for this day.';
                        }
                    }

                    if (formEl && logData) {
                        const feelingContainer = formEl.querySelector('[data-metric="feeling"]');
                        if (logData.feeling) {
                            feelingContainer.dataset.rating = logData.feeling;
                            feelingContainer.querySelectorAll('.rating-emoji').forEach(e => {
                                e.classList.toggle('selected', e.dataset.value === logData.feeling);
                            });
                        }
                        const swellingContainer = formEl.querySelector('[data-metric="swelling"]');
                        if(logData.swelling) {
                             swellingContainer.dataset.rating = logData.swelling;
                             swellingContainer.querySelectorAll('.rating-bar').forEach((b, i) => {
                                 b.className = `rating-bar flex-1 h-3 ${i < logData.swelling ? ratingColors[i+1] : 'bg-gray-600'} transition-colors`;
                             });
                             swellingContainer.querySelector('.rating-bar').classList.add('rounded-l-lg');
                             swellingContainer.querySelector('.rating-bar:last-child').classList.add('rounded-r-lg');
                        }
                        const scarContainer = formEl.querySelector('[data-metric="scar"]');
                        if(logData.scar) {
                             scarContainer.dataset.rating = logData.scar;
                             scarContainer.querySelectorAll('.rating-bar').forEach((b, i) => {
                                 b.className = `rating-bar flex-1 h-3 ${i < logData.scar ? ratingColors[i+1] : 'bg-gray-600'} transition-colors`;
                             });
                             scarContainer.querySelector('.rating-bar').classList.add('rounded-l-lg');
                             scarContainer.querySelector('.rating-bar:last-child').classList.add('rounded-r-lg');
                        }
                        formEl.querySelector(`#notes-${dayIndex}`).value = logData.notes || '';
                    }
                }
            }
            
            modalClose.addEventListener('click', closeModal); 
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); }); 
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
            
            runApp();
        });
    </script>
</body>
</html>
